"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.startServer = exports.DEFAULT_SERVER_OPTIONS = void 0;
const tiny_node_logger_1 = __importDefault(require("tiny-node-logger"));
const request_handler_1 = require("./request-handler");
const watcher_1 = require("./watcher");
const backbone_1 = require("./backbone");
const hmr_server_1 = require("./hmr-server");
exports.DEFAULT_SERVER_OPTIONS = {
    protocol: "http",
    host: "localhost",
    port: 3000,
    options: {}
};
async function startServer(options) {
    const { server: { protocol, host, port, options: serverOptions = {} } = exports.DEFAULT_SERVER_OPTIONS } = options;
    const watcher = watcher_1.useWatcher(options);
    const handler = request_handler_1.useRequestHandler(options);
    let module, server;
    if (options.http2) {
        module = require("http2");
        if (protocol === "http") {
            server = module.createServer(serverOptions, handler);
        }
        else {
            server = module.createSecureServer(serverOptions, handler);
        }
    }
    else {
        if (protocol === "http") {
            module = require("http");
            server = module.createServer(serverOptions, handler);
        }
        else {
            module = require("https");
            server = module.createServer(serverOptions, handler);
        }
    }
    await new Promise(resolve => server.listen(port, host, resolve));
    const address = `${protocol}://${host}:${port}`;
    tiny_node_logger_1.default.info(`server started on ${address}`);
    hmr_server_1.useHotModuleReplacement(options).connect(server);
    server.on("upgrade", backbone_1.useBackbone(options).handleUpgrade);
    const sockets = new Set();
    server.on("connection", function (socket) {
        sockets.add(socket);
        socket.on("close", () => sockets.delete(socket));
    });
    server.on("secureConnection", function (socket) {
        sockets.add(socket);
        socket.on("close", () => sockets.delete(socket));
    });
    let closed;
    async function shutdown() {
        if (closed) {
            tiny_node_logger_1.default.debug("server already closed");
            await closed;
        }
        closed = new Promise(resolve => server.on("close", resolve));
        if (sockets.size > 0) {
            tiny_node_logger_1.default.debug(`closing ${sockets.size} pending socket...`);
            for (const socket of sockets) {
                socket.destroy();
                sockets.delete(socket);
            }
        }
        tiny_node_logger_1.default.debug(`closing chokidar watcher...`);
        await watcher.close();
        server.close();
        await closed;
        tiny_node_logger_1.default.info("server closed");
        return closed;
    }
    return {
        config: options,
        module,
        server,
        watcher,
        handler,
        address,
        shutdown
    };
}
exports.startServer = startServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSx3RUFBbUM7QUFFbkMsdURBQW9EO0FBQ3BELHVDQUFxQztBQUNyQyx5Q0FBdUM7QUFDdkMsNkNBQXFEO0FBYXhDLFFBQUEsc0JBQXNCLEdBQWtCO0lBQ2pELFFBQVEsRUFBRSxNQUFNO0lBQ2hCLElBQUksRUFBRSxXQUFXO0lBQ2pCLElBQUksRUFBRSxJQUFJO0lBQ1YsT0FBTyxFQUFFLEVBQUU7Q0FDZCxDQUFDO0FBT0ssS0FBSyxVQUFVLFdBQVcsQ0FBQyxPQUFzQjtJQUVwRCxNQUFNLEVBQ0YsTUFBTSxFQUFFLEVBQ0osUUFBUSxFQUNSLElBQUksRUFDSixJQUFJLEVBQ0osT0FBTyxFQUFFLGFBQWEsR0FBRyxFQUFFLEVBQzlCLEdBQUcsOEJBQXNCLEVBQzdCLEdBQUcsT0FBTyxDQUFDO0lBRVosTUFBTSxPQUFPLEdBQUcsb0JBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQyxNQUFNLE9BQU8sR0FBRyxtQ0FBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUUzQyxJQUFJLE1BQU0sRUFBRSxNQUE4QyxDQUFDO0lBRTNELElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtRQUNmLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUIsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUFFO1lBQ3JCLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsTUFBTSxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDOUQ7S0FDSjtTQUFNO1FBQ0gsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUFFO1lBQ3JCLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDekIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3hEO2FBQU07WUFDSCxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzFCLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN4RDtLQUNKO0lBRUQsTUFBTSxJQUFJLE9BQU8sQ0FBTyxPQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBRXZFLE1BQU0sT0FBTyxHQUFHLEdBQUcsUUFBUSxNQUFNLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUNoRCwwQkFBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUV6QyxvQ0FBdUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFakQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsc0JBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUV6RCxNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0lBRWxDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLFVBQVUsTUFBTTtRQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsVUFBVSxNQUFNO1FBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxNQUFNLENBQUM7SUFFWCxLQUFLLFVBQVUsUUFBUTtRQUNuQixJQUFJLE1BQU0sRUFBRTtZQUNSLDBCQUFHLENBQUMsS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDbkMsTUFBTSxNQUFNLENBQUM7U0FDaEI7UUFFRCxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUU7WUFDbEIsMEJBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxPQUFPLENBQUMsSUFBSSxvQkFBb0IsQ0FBQyxDQUFDO1lBQ3ZELEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFO2dCQUMxQixNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDMUI7U0FDSjtRQUVELDBCQUFHLENBQUMsS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDekMsTUFBTSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFdEIsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsTUFBTSxNQUFNLENBQUM7UUFDYiwwQkFBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUUxQixPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsT0FBTztRQUNILE1BQU0sRUFBRSxPQUFPO1FBQ2YsTUFBTTtRQUNOLE1BQU07UUFDTixPQUFPO1FBQ1AsT0FBTztRQUNQLE9BQU87UUFDUCxRQUFRO0tBQ1gsQ0FBQztBQUNOLENBQUM7QUExRkQsa0NBMEZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGU1dhdGNoZXJ9IGZyb20gXCJjaG9raWRhclwiO1xuaW1wb3J0IFJvdXRlciwge0hhbmRsZXIsIEhUVFBWZXJzaW9ufSBmcm9tIFwiZmluZC1teS13YXlcIjtcbmltcG9ydCB7U2VydmVyIGFzIEh0dHBTZXJ2ZXJ9IGZyb20gXCJodHRwXCI7XG5pbXBvcnQge0h0dHAyU2VydmVyfSBmcm9tIFwiaHR0cDJcIjtcbmltcG9ydCB7U2VydmVyIGFzIEh0dHBzU2VydmVyfSBmcm9tIFwiaHR0cHNcIjtcbmltcG9ydCB7U29ja2V0fSBmcm9tIFwibmV0XCI7XG5pbXBvcnQgbG9nIGZyb20gXCJ0aW55LW5vZGUtbG9nZ2VyXCI7XG5pbXBvcnQge0VTTmV4dE9wdGlvbnN9IGZyb20gXCIuL2NvbmZpZ3VyZVwiO1xuaW1wb3J0IHt1c2VSZXF1ZXN0SGFuZGxlcn0gZnJvbSBcIi4vcmVxdWVzdC1oYW5kbGVyXCI7XG5pbXBvcnQge3VzZVdhdGNoZXJ9IGZyb20gXCIuL3dhdGNoZXJcIjtcbmltcG9ydCB7dXNlQmFja2JvbmV9IGZyb20gXCIuL2JhY2tib25lXCI7XG5pbXBvcnQge3VzZUhvdE1vZHVsZVJlcGxhY2VtZW50fSBmcm9tIFwiLi9obXItc2VydmVyXCI7XG5cbmV4cG9ydCB0eXBlIFNlcnZlck9wdGlvbnMgPSB7XG4gICAgcHJvdG9jb2w/OiBcImh0dHBcIiB8IFwiaHR0cHNcIlxuICAgIGhvc3Q/OiBzdHJpbmdcbiAgICBwb3J0PzogbnVtYmVyXG4gICAgb3B0aW9ucz86IHtcbiAgICAgICAga2V5Pzogc3RyaW5nXG4gICAgICAgIGNlcnQ/OiBzdHJpbmdcbiAgICAgICAgYWxsb3dIVFRQMT86IGJvb2xlYW5cbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1NFUlZFUl9PUFRJT05TOiBTZXJ2ZXJPcHRpb25zID0ge1xuICAgIHByb3RvY29sOiBcImh0dHBcIixcbiAgICBob3N0OiBcImxvY2FsaG9zdFwiLFxuICAgIHBvcnQ6IDMwMDAsXG4gICAgb3B0aW9uczoge31cbn07XG5cbmV4cG9ydCB0eXBlIFNlcnZpY2VzID0ge1xuICAgIHdhdGNoZXI/OiBGU1dhdGNoZXJcbiAgICBoYW5kbGVyPzogSGFuZGxlcjxIVFRQVmVyc2lvbi5WMXxIVFRQVmVyc2lvbi5WMj5cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyKG9wdGlvbnM6IEVTTmV4dE9wdGlvbnMpIHtcblxuICAgIGNvbnN0IHtcbiAgICAgICAgc2VydmVyOiB7XG4gICAgICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgICAgIGhvc3QsXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgb3B0aW9uczogc2VydmVyT3B0aW9ucyA9IHt9XG4gICAgICAgIH0gPSBERUZBVUxUX1NFUlZFUl9PUFRJT05TXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICBjb25zdCB3YXRjaGVyID0gdXNlV2F0Y2hlcihvcHRpb25zKTtcbiAgICBjb25zdCBoYW5kbGVyID0gdXNlUmVxdWVzdEhhbmRsZXIob3B0aW9ucyk7XG5cbiAgICBsZXQgbW9kdWxlLCBzZXJ2ZXI6IEh0dHBTZXJ2ZXIgfCBIdHRwc1NlcnZlciB8IEh0dHAyU2VydmVyO1xuXG4gICAgaWYgKG9wdGlvbnMuaHR0cDIpIHtcbiAgICAgICAgbW9kdWxlID0gcmVxdWlyZShcImh0dHAyXCIpO1xuICAgICAgICBpZiAocHJvdG9jb2wgPT09IFwiaHR0cFwiKSB7XG4gICAgICAgICAgICBzZXJ2ZXIgPSBtb2R1bGUuY3JlYXRlU2VydmVyKHNlcnZlck9wdGlvbnMsIGhhbmRsZXIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2VydmVyID0gbW9kdWxlLmNyZWF0ZVNlY3VyZVNlcnZlcihzZXJ2ZXJPcHRpb25zLCBoYW5kbGVyKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChwcm90b2NvbCA9PT0gXCJodHRwXCIpIHtcbiAgICAgICAgICAgIG1vZHVsZSA9IHJlcXVpcmUoXCJodHRwXCIpO1xuICAgICAgICAgICAgc2VydmVyID0gbW9kdWxlLmNyZWF0ZVNlcnZlcihzZXJ2ZXJPcHRpb25zLCBoYW5kbGVyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1vZHVsZSA9IHJlcXVpcmUoXCJodHRwc1wiKTtcbiAgICAgICAgICAgIHNlcnZlciA9IG1vZHVsZS5jcmVhdGVTZXJ2ZXIoc2VydmVyT3B0aW9ucywgaGFuZGxlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHNlcnZlci5saXN0ZW4ocG9ydCwgaG9zdCwgcmVzb2x2ZSkpO1xuXG4gICAgY29uc3QgYWRkcmVzcyA9IGAke3Byb3RvY29sfTovLyR7aG9zdH06JHtwb3J0fWA7XG4gICAgbG9nLmluZm8oYHNlcnZlciBzdGFydGVkIG9uICR7YWRkcmVzc31gKTtcblxuICAgIHVzZUhvdE1vZHVsZVJlcGxhY2VtZW50KG9wdGlvbnMpLmNvbm5lY3Qoc2VydmVyKTtcblxuICAgIHNlcnZlci5vbihcInVwZ3JhZGVcIiwgdXNlQmFja2JvbmUob3B0aW9ucykuaGFuZGxlVXBncmFkZSk7XG5cbiAgICBjb25zdCBzb2NrZXRzID0gbmV3IFNldDxTb2NrZXQ+KCk7XG5cbiAgICBzZXJ2ZXIub24oXCJjb25uZWN0aW9uXCIsIGZ1bmN0aW9uIChzb2NrZXQpIHtcbiAgICAgICAgc29ja2V0cy5hZGQoc29ja2V0KTtcbiAgICAgICAgc29ja2V0Lm9uKFwiY2xvc2VcIiwgKCkgPT4gc29ja2V0cy5kZWxldGUoc29ja2V0KSk7XG4gICAgfSk7XG4gICAgc2VydmVyLm9uKFwic2VjdXJlQ29ubmVjdGlvblwiLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgICAgIHNvY2tldHMuYWRkKHNvY2tldCk7XG4gICAgICAgIHNvY2tldC5vbihcImNsb3NlXCIsICgpID0+IHNvY2tldHMuZGVsZXRlKHNvY2tldCkpO1xuICAgIH0pO1xuXG4gICAgbGV0IGNsb3NlZDtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIHNodXRkb3duKHRoaXM6IGFueSkge1xuICAgICAgICBpZiAoY2xvc2VkKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoXCJzZXJ2ZXIgYWxyZWFkeSBjbG9zZWRcIik7XG4gICAgICAgICAgICBhd2FpdCBjbG9zZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBjbG9zZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNlcnZlci5vbihcImNsb3NlXCIsIHJlc29sdmUpKTtcblxuICAgICAgICBpZiAoc29ja2V0cy5zaXplID4gMCkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBjbG9zaW5nICR7c29ja2V0cy5zaXplfSBwZW5kaW5nIHNvY2tldC4uLmApO1xuICAgICAgICAgICAgZm9yIChjb25zdCBzb2NrZXQgb2Ygc29ja2V0cykge1xuICAgICAgICAgICAgICAgIHNvY2tldC5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgc29ja2V0cy5kZWxldGUoc29ja2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxvZy5kZWJ1ZyhgY2xvc2luZyBjaG9raWRhciB3YXRjaGVyLi4uYCk7XG4gICAgICAgIGF3YWl0IHdhdGNoZXIuY2xvc2UoKTtcblxuICAgICAgICBzZXJ2ZXIuY2xvc2UoKTtcbiAgICAgICAgYXdhaXQgY2xvc2VkO1xuICAgICAgICBsb2cuaW5mbyhcInNlcnZlciBjbG9zZWRcIik7XG5cbiAgICAgICAgcmV0dXJuIGNsb3NlZDtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBjb25maWc6IG9wdGlvbnMsXG4gICAgICAgIG1vZHVsZSxcbiAgICAgICAgc2VydmVyLFxuICAgICAgICB3YXRjaGVyLFxuICAgICAgICBoYW5kbGVyLFxuICAgICAgICBhZGRyZXNzLFxuICAgICAgICBzaHV0ZG93blxuICAgIH07XG59XG4iXX0=