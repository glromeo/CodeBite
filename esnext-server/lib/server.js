"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.startServer = exports.DEFAULT_SERVER_OPTIONS = void 0;
const tiny_node_logger_1 = __importDefault(require("tiny-node-logger"));
const request_handler_1 = require("./request-handler");
const watcher_1 = require("./watcher");
const websockets_1 = require("./websockets");
const hmr_server_1 = require("./hmr-server");
exports.DEFAULT_SERVER_OPTIONS = {
    protocol: "http",
    host: "localhost",
    port: 3000,
    options: {}
};
async function startServer(options, services = {}) {
    const { server: { protocol, host, port, options: serverOptions = {} } = exports.DEFAULT_SERVER_OPTIONS } = options;
    const watcher = services.watcher || watcher_1.createWatcher(options);
    const handler = services.handler || request_handler_1.createRequestHandler(options, watcher);
    let module, server;
    if (options.http2) {
        module = require("http2");
        if (protocol === "http") {
            server = module.createServer(serverOptions, handler);
        }
        else {
            server = module.createSecureServer(serverOptions, handler);
        }
    }
    else {
        if (protocol === "http") {
            module = require("http");
            server = module.createServer(serverOptions, handler);
        }
        else {
            module = require("https");
            server = module.createServer(serverOptions, handler);
        }
    }
    await new Promise(resolve => server.listen(port, host, resolve));
    const address = `${protocol}://${host}:${port}`;
    tiny_node_logger_1.default.info(`server started on ${address}`);
    hmr_server_1.useHotModuleReplacement(options).connect(server);
    websockets_1.createWebSockets(options, server, watcher);
    const sockets = new Set();
    server.on("connection", function (socket) {
        sockets.add(socket);
        socket.on("close", () => sockets.delete(socket));
    });
    server.on("secureConnection", function (socket) {
        sockets.add(socket);
        socket.on("close", () => sockets.delete(socket));
    });
    let closed;
    async function shutdown() {
        if (closed) {
            tiny_node_logger_1.default.debug("server already closed");
            await closed;
        }
        closed = new Promise(resolve => server.on("close", resolve));
        if (sockets.size > 0) {
            tiny_node_logger_1.default.debug(`closing ${sockets.size} pending socket...`);
            for (const socket of sockets) {
                socket.destroy();
                sockets.delete(socket);
            }
        }
        tiny_node_logger_1.default.debug(`closing chokidar watcher...`);
        await watcher.close();
        server.close();
        await closed;
        tiny_node_logger_1.default.info("server closed");
        return closed;
    }
    return {
        config: options,
        module,
        server,
        watcher,
        handler,
        address,
        shutdown
    };
}
exports.startServer = startServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSx3RUFBbUM7QUFFbkMsdURBQXVEO0FBQ3ZELHVDQUF3QztBQUN4Qyw2Q0FBOEM7QUFDOUMsNkNBQW1FO0FBYXRELFFBQUEsc0JBQXNCLEdBQWtCO0lBQ2pELFFBQVEsRUFBRSxNQUFNO0lBQ2hCLElBQUksRUFBRSxXQUFXO0lBQ2pCLElBQUksRUFBRSxJQUFJO0lBQ1YsT0FBTyxFQUFFLEVBQUU7Q0FDZCxDQUFDO0FBT0ssS0FBSyxVQUFVLFdBQVcsQ0FBQyxPQUFzQixFQUFFLFdBQXFCLEVBQUU7SUFFN0UsTUFBTSxFQUNGLE1BQU0sRUFBRSxFQUNKLFFBQVEsRUFDUixJQUFJLEVBQ0osSUFBSSxFQUNKLE9BQU8sRUFBRSxhQUFhLEdBQUcsRUFBRSxFQUM5QixHQUFHLDhCQUFzQixFQUM3QixHQUFHLE9BQU8sQ0FBQztJQUVaLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLElBQUksdUJBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzRCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxJQUFJLHNDQUFvQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUUzRSxJQUFJLE1BQU0sRUFBRSxNQUE4QyxDQUFDO0lBRTNELElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtRQUNmLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUIsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUFFO1lBQ3JCLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsTUFBTSxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDOUQ7S0FDSjtTQUFNO1FBQ0gsSUFBSSxR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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGU1dhdGNoZXJ9IGZyb20gXCJjaG9raWRhclwiO1xyXG5pbXBvcnQgUm91dGVyLCB7SGFuZGxlciwgSFRUUFZlcnNpb259IGZyb20gXCJmaW5kLW15LXdheVwiO1xyXG5pbXBvcnQge1NlcnZlciBhcyBIdHRwU2VydmVyfSBmcm9tIFwiaHR0cFwiO1xyXG5pbXBvcnQge0h0dHAyU2VydmVyfSBmcm9tIFwiaHR0cDJcIjtcclxuaW1wb3J0IHtTZXJ2ZXIgYXMgSHR0cHNTZXJ2ZXJ9IGZyb20gXCJodHRwc1wiO1xyXG5pbXBvcnQge1NvY2tldH0gZnJvbSBcIm5ldFwiO1xyXG5pbXBvcnQgbG9nIGZyb20gXCJ0aW55LW5vZGUtbG9nZ2VyXCI7XHJcbmltcG9ydCB7RVNOZXh0T3B0aW9uc30gZnJvbSBcIi4vY29uZmlndXJlXCI7XHJcbmltcG9ydCB7Y3JlYXRlUmVxdWVzdEhhbmRsZXJ9IGZyb20gXCIuL3JlcXVlc3QtaGFuZGxlclwiO1xyXG5pbXBvcnQge2NyZWF0ZVdhdGNoZXJ9IGZyb20gXCIuL3dhdGNoZXJcIjtcclxuaW1wb3J0IHtjcmVhdGVXZWJTb2NrZXRzfSBmcm9tIFwiLi93ZWJzb2NrZXRzXCI7XHJcbmltcG9ydCB7RXNtSG1yRW5naW5lLCB1c2VIb3RNb2R1bGVSZXBsYWNlbWVudH0gZnJvbSBcIi4vaG1yLXNlcnZlclwiO1xyXG5cclxuZXhwb3J0IHR5cGUgU2VydmVyT3B0aW9ucyA9IHtcclxuICAgIHByb3RvY29sPzogXCJodHRwXCIgfCBcImh0dHBzXCJcclxuICAgIGhvc3Q/OiBzdHJpbmdcclxuICAgIHBvcnQ/OiBudW1iZXJcclxuICAgIG9wdGlvbnM/OiB7XHJcbiAgICAgICAga2V5Pzogc3RyaW5nXHJcbiAgICAgICAgY2VydD86IHN0cmluZ1xyXG4gICAgICAgIGFsbG93SFRUUDE/OiBib29sZWFuXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBERUZBVUxUX1NFUlZFUl9PUFRJT05TOiBTZXJ2ZXJPcHRpb25zID0ge1xyXG4gICAgcHJvdG9jb2w6IFwiaHR0cFwiLFxyXG4gICAgaG9zdDogXCJsb2NhbGhvc3RcIixcclxuICAgIHBvcnQ6IDMwMDAsXHJcbiAgICBvcHRpb25zOiB7fVxyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgU2VydmljZXMgPSB7XHJcbiAgICB3YXRjaGVyPzogRlNXYXRjaGVyXHJcbiAgICBoYW5kbGVyPzogSGFuZGxlcjxIVFRQVmVyc2lvbi5WMXxIVFRQVmVyc2lvbi5WMj5cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyKG9wdGlvbnM6IEVTTmV4dE9wdGlvbnMsIHNlcnZpY2VzOiBTZXJ2aWNlcyA9IHt9KSB7XHJcblxyXG4gICAgY29uc3Qge1xyXG4gICAgICAgIHNlcnZlcjoge1xyXG4gICAgICAgICAgICBwcm90b2NvbCxcclxuICAgICAgICAgICAgaG9zdCxcclxuICAgICAgICAgICAgcG9ydCxcclxuICAgICAgICAgICAgb3B0aW9uczogc2VydmVyT3B0aW9ucyA9IHt9XHJcbiAgICAgICAgfSA9IERFRkFVTFRfU0VSVkVSX09QVElPTlNcclxuICAgIH0gPSBvcHRpb25zO1xyXG5cclxuICAgIGNvbnN0IHdhdGNoZXIgPSBzZXJ2aWNlcy53YXRjaGVyIHx8IGNyZWF0ZVdhdGNoZXIob3B0aW9ucyk7XHJcbiAgICBjb25zdCBoYW5kbGVyID0gc2VydmljZXMuaGFuZGxlciB8fCBjcmVhdGVSZXF1ZXN0SGFuZGxlcihvcHRpb25zLCB3YXRjaGVyKTtcclxuXHJcbiAgICBsZXQgbW9kdWxlLCBzZXJ2ZXI6IEh0dHBTZXJ2ZXIgfCBIdHRwc1NlcnZlciB8IEh0dHAyU2VydmVyO1xyXG5cclxuICAgIGlmIChvcHRpb25zLmh0dHAyKSB7XHJcbiAgICAgICAgbW9kdWxlID0gcmVxdWlyZShcImh0dHAyXCIpO1xyXG4gICAgICAgIGlmIChwcm90b2NvbCA9PT0gXCJodHRwXCIpIHtcclxuICAgICAgICAgICAgc2VydmVyID0gbW9kdWxlLmNyZWF0ZVNlcnZlcihzZXJ2ZXJPcHRpb25zLCBoYW5kbGVyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzZXJ2ZXIgPSBtb2R1bGUuY3JlYXRlU2VjdXJlU2VydmVyKHNlcnZlck9wdGlvbnMsIGhhbmRsZXIpO1xyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKHByb3RvY29sID09PSBcImh0dHBcIikge1xyXG4gICAgICAgICAgICBtb2R1bGUgPSByZXF1aXJlKFwiaHR0cFwiKTtcclxuICAgICAgICAgICAgc2VydmVyID0gbW9kdWxlLmNyZWF0ZVNlcnZlcihzZXJ2ZXJPcHRpb25zLCBoYW5kbGVyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBtb2R1bGUgPSByZXF1aXJlKFwiaHR0cHNcIik7XHJcbiAgICAgICAgICAgIHNlcnZlciA9IG1vZHVsZS5jcmVhdGVTZXJ2ZXIoc2VydmVyT3B0aW9ucywgaGFuZGxlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4gc2VydmVyLmxpc3Rlbihwb3J0LCBob3N0LCByZXNvbHZlKSk7XHJcblxyXG4gICAgY29uc3QgYWRkcmVzcyA9IGAke3Byb3RvY29sfTovLyR7aG9zdH06JHtwb3J0fWA7XHJcbiAgICBsb2cuaW5mbyhgc2VydmVyIHN0YXJ0ZWQgb24gJHthZGRyZXNzfWApO1xyXG5cclxuICAgIHVzZUhvdE1vZHVsZVJlcGxhY2VtZW50KG9wdGlvbnMpLmNvbm5lY3Qoc2VydmVyKTtcclxuXHJcbiAgICBjcmVhdGVXZWJTb2NrZXRzKG9wdGlvbnMsIHNlcnZlciwgd2F0Y2hlcik7XHJcblxyXG4gICAgY29uc3Qgc29ja2V0cyA9IG5ldyBTZXQ8U29ja2V0PigpO1xyXG5cclxuICAgIHNlcnZlci5vbihcImNvbm5lY3Rpb25cIiwgZnVuY3Rpb24gKHNvY2tldCkge1xyXG4gICAgICAgIHNvY2tldHMuYWRkKHNvY2tldCk7XHJcbiAgICAgICAgc29ja2V0Lm9uKFwiY2xvc2VcIiwgKCkgPT4gc29ja2V0cy5kZWxldGUoc29ja2V0KSk7XHJcbiAgICB9KTtcclxuICAgIHNlcnZlci5vbihcInNlY3VyZUNvbm5lY3Rpb25cIiwgZnVuY3Rpb24gKHNvY2tldCkge1xyXG4gICAgICAgIHNvY2tldHMuYWRkKHNvY2tldCk7XHJcbiAgICAgICAgc29ja2V0Lm9uKFwiY2xvc2VcIiwgKCkgPT4gc29ja2V0cy5kZWxldGUoc29ja2V0KSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBsZXQgY2xvc2VkO1xyXG5cclxuICAgIGFzeW5jIGZ1bmN0aW9uIHNodXRkb3duKHRoaXM6IGFueSkge1xyXG4gICAgICAgIGlmIChjbG9zZWQpIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKFwic2VydmVyIGFscmVhZHkgY2xvc2VkXCIpO1xyXG4gICAgICAgICAgICBhd2FpdCBjbG9zZWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbG9zZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNlcnZlci5vbihcImNsb3NlXCIsIHJlc29sdmUpKTtcclxuXHJcbiAgICAgICAgaWYgKHNvY2tldHMuc2l6ZSA+IDApIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKGBjbG9zaW5nICR7c29ja2V0cy5zaXplfSBwZW5kaW5nIHNvY2tldC4uLmApO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNvY2tldCBvZiBzb2NrZXRzKSB7XHJcbiAgICAgICAgICAgICAgICBzb2NrZXQuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgc29ja2V0cy5kZWxldGUoc29ja2V0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbG9nLmRlYnVnKGBjbG9zaW5nIGNob2tpZGFyIHdhdGNoZXIuLi5gKTtcclxuICAgICAgICBhd2FpdCB3YXRjaGVyLmNsb3NlKCk7XHJcblxyXG4gICAgICAgIHNlcnZlci5jbG9zZSgpO1xyXG4gICAgICAgIGF3YWl0IGNsb3NlZDtcclxuICAgICAgICBsb2cuaW5mbyhcInNlcnZlciBjbG9zZWRcIik7XHJcblxyXG4gICAgICAgIHJldHVybiBjbG9zZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBjb25maWc6IG9wdGlvbnMsXHJcbiAgICAgICAgbW9kdWxlLFxyXG4gICAgICAgIHNlcnZlcixcclxuICAgICAgICB3YXRjaGVyLFxyXG4gICAgICAgIGhhbmRsZXIsXHJcbiAgICAgICAgYWRkcmVzcyxcclxuICAgICAgICBzaHV0ZG93blxyXG4gICAgfTtcclxufVxyXG4iXX0=