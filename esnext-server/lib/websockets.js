"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createWebSockets = void 0;
const chalk_1 = __importDefault(require("chalk"));
const fs_1 = require("fs");
const path_1 = require("path");
const tiny_node_logger_1 = __importDefault(require("tiny-node-logger"));
const ws_1 = __importDefault(require("ws"));
const esnext_web_modules_1 = require("esnext-web-modules");
const WS_CONFIG_FILE = "websockets.config.js";
function createWebSockets(config, server, watcher) {
    const wss = new ws_1.default.Server({ noServer: true });
    server.on("upgrade", (req, socket, head) => {
        if (req.headers["sec-websocket-protocol"] !== "esm-hmr") {
            wss.handleUpgrade(req, socket, head, (client) => {
                wss.emit("connection", client, req);
            });
        }
    });
    const listeners = new Map();
    function on(name, listener) {
        listeners.set(name, listener);
        tiny_node_logger_1.default.debug("added message listener:", chalk_1.default.magenta(name));
    }
    watcher.on("all", async function (event, path) {
        if (path.endsWith(WS_CONFIG_FILE)) {
            const module = path_1.resolve(config.rootDir, path);
            const context = {
                dirname: path_1.dirname(module),
                filename: module
            };
            delete require.cache[require.resolve(module)];
            tiny_node_logger_1.default.info("websockets:", chalk_1.default.underline(module));
            require(module).call(context, config, watcher, on);
        }
    });
    for (const basedir of Object.values(config.mount)) {
        const filename = path_1.resolve(config.rootDir, basedir, WS_CONFIG_FILE);
        if (fs_1.existsSync(filename)) {
            watcher.add(filename);
        }
    }
    function marshall(header, payload) {
        return payload ? `${header}:${JSON.stringify(payload)}` : header;
    }
    function unmarshall(message) {
        const sep = message.indexOf(":");
        let header, payload;
        if (sep !== -1) {
            header = message.substring(0, sep);
            payload = JSON.parse(message.substring(sep + 1));
        }
        else {
            header = message;
        }
        tiny_node_logger_1.default.debug("ws:", header, message.length < 250 ? payload : `{...}`);
        return { header, payload };
    }
    const clients = new Set();
    wss.on("connection", ws => {
        ws.on("message", message => {
            const { header, payload } = unmarshall(message);
            const listener = listeners.get(header);
            if (listener) {
                listener.call(listeners, payload, (header, payload) => ws.send(marshall(header, payload)));
            }
        });
        ws.send("connected:" + JSON.stringify({ since: new Date().toUTCString() }));
        clients.add(ws);
        ws.on("close", function () {
            clients.delete(ws);
        });
    });
    function broadcast(header, payload) {
        let message = marshall(header, payload);
        for (const client of clients) {
            client.send(message);
        }
    }
    esnext_web_modules_1.notifications.on("new", (notification) => {
        broadcast("notification:new", notification);
    });
    esnext_web_modules_1.notifications.on("update", (notification) => {
        broadcast("notification:update", notification);
    });
}
exports.createWebSockets = createWebSockets;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWJzb2NrZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtEQUEwQjtBQUMxQiwyQkFBOEI7QUFDOUIsK0JBQXNDO0FBQ3RDLHdFQUFtQztBQUNuQyw0Q0FBMkI7QUFDM0IsMkRBQXdGO0FBRXhGLE1BQU0sY0FBYyxHQUFHLHNCQUFzQixDQUFDO0FBRTlDLFNBQWdCLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTztJQUVwRCxNQUFNLEdBQUcsR0FBRyxJQUFJLFlBQVMsQ0FBQyxNQUFNLENBQUMsRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUVuRCxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDdkMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLEtBQUssU0FBUyxFQUFFO1lBQ3JELEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFFNUIsU0FBUyxFQUFFLENBQUMsSUFBSSxFQUFFLFFBQVE7UUFDdEIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUIsMEJBQUcsQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsZUFBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRCxPQUFP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QUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM5RjtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEtBQUssRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEIsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7WUFDWCxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLFNBQVMsQ0FBQyxNQUFhLEVBQUUsT0FBVztRQUN6QyxJQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFO1lBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEI7SUFDTCxDQUFDO0lBRUQsa0NBQWEsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsWUFBbUMsRUFBRSxFQUFFO1FBQzVELFNBQVMsQ0FBQyxrQkFBa0IsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztJQUVILGtDQUFhLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLFlBQW1DLEVBQUUsRUFBRTtRQUMvRCxTQUFTLENBQUMscUJBQXFCLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBOUZELDRDQThGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIjtcbmltcG9ydCB7ZXhpc3RzU3luY30gZnJvbSBcImZzXCI7XG5pbXBvcnQge2Rpcm5hbWUsIHJlc29sdmV9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgbG9nIGZyb20gXCJ0aW55LW5vZGUtbG9nZ2VyXCI7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gXCJ3c1wiO1xuaW1wb3J0IHt1c2VXZWJNb2R1bGVzLCBub3RpZmljYXRpb25zLCBXZWJNb2R1bGVzTm90aWZpY2F0aW9ufSBmcm9tIFwiZXNuZXh0LXdlYi1tb2R1bGVzXCI7XG5cbmNvbnN0IFdTX0NPTkZJR19GSUxFID0gXCJ3ZWJzb2NrZXRzLmNvbmZpZy5qc1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlV2ViU29ja2V0cyhjb25maWcsIHNlcnZlciwgd2F0Y2hlcikge1xuXG4gICAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe25vU2VydmVyOiB0cnVlfSk7XG5cbiAgICBzZXJ2ZXIub24oXCJ1cGdyYWRlXCIsIChyZXEsIHNvY2tldCwgaGVhZCkgPT4ge1xuICAgICAgICBpZiAocmVxLmhlYWRlcnNbXCJzZWMtd2Vic29ja2V0LXByb3RvY29sXCJdICE9PSBcImVzbS1obXJcIikge1xuICAgICAgICAgICAgd3NzLmhhbmRsZVVwZ3JhZGUocmVxLCBzb2NrZXQsIGhlYWQsIChjbGllbnQpID0+IHtcbiAgICAgICAgICAgICAgICB3c3MuZW1pdChcImNvbm5lY3Rpb25cIiwgY2xpZW50LCByZXEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IGxpc3RlbmVycyA9IG5ldyBNYXAoKTtcblxuICAgIGZ1bmN0aW9uIG9uKG5hbWUsIGxpc3RlbmVyKSB7XG4gICAgICAgIGxpc3RlbmVycy5zZXQobmFtZSwgbGlzdGVuZXIpO1xuICAgICAgICBsb2cuZGVidWcoXCJhZGRlZCBtZXNzYWdlIGxpc3RlbmVyOlwiLCBjaGFsay5tYWdlbnRhKG5hbWUpKTtcbiAgICB9XG5cbiAgICB3YXRjaGVyLm9uKFwiYWxsXCIsIGFzeW5jIGZ1bmN0aW9uIChldmVudCwgcGF0aCkge1xuXG4gICAgICAgIGlmIChwYXRoLmVuZHNXaXRoKFdTX0NPTkZJR19GSUxFKSkge1xuICAgICAgICAgICAgY29uc3QgbW9kdWxlID0gcmVzb2x2ZShjb25maWcucm9vdERpciwgcGF0aCk7XG4gICAgICAgICAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIGRpcm5hbWU6IGRpcm5hbWUobW9kdWxlKSxcbiAgICAgICAgICAgICAgICBmaWxlbmFtZTogbW9kdWxlXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtyZXF1aXJlLnJlc29sdmUobW9kdWxlKV07XG5cbiAgICAgICAgICAgIGxvZy5pbmZvKFwid2Vic29ja2V0czpcIiwgY2hhbGsudW5kZXJsaW5lKG1vZHVsZSkpO1xuICAgICAgICAgICAgcmVxdWlyZShtb2R1bGUpLmNhbGwoY29udGV4dCwgY29uZmlnLCB3YXRjaGVyLCBvbik7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgYmFzZWRpciBvZiBPYmplY3QudmFsdWVzPHN0cmluZz4oY29uZmlnLm1vdW50KSkge1xuICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHJlc29sdmUoY29uZmlnLnJvb3REaXIsIGJhc2VkaXIsIFdTX0NPTkZJR19GSUxFKTtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoZmlsZW5hbWUpKSB7XG4gICAgICAgICAgICB3YXRjaGVyLmFkZChmaWxlbmFtZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBtYXJzaGFsbChoZWFkZXI6c3RyaW5nLCBwYXlsb2FkOmFueSkge1xuICAgICAgICByZXR1cm4gcGF5bG9hZCA/IGAke2hlYWRlcn06JHtKU09OLnN0cmluZ2lmeShwYXlsb2FkKX1gIDogaGVhZGVyO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHVubWFyc2hhbGwobWVzc2FnZSkge1xuICAgICAgICBjb25zdCBzZXAgPSBtZXNzYWdlLmluZGV4T2YoXCI6XCIpO1xuICAgICAgICBsZXQgaGVhZGVyLCBwYXlsb2FkO1xuICAgICAgICBpZiAoc2VwICE9PSAtMSkge1xuICAgICAgICAgICAgaGVhZGVyID0gbWVzc2FnZS5zdWJzdHJpbmcoMCwgc2VwKTtcbiAgICAgICAgICAgIHBheWxvYWQgPSBKU09OLnBhcnNlKG1lc3NhZ2Uuc3Vic3RyaW5nKHNlcCArIDEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhlYWRlciA9IG1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmRlYnVnKFwid3M6XCIsIGhlYWRlciwgbWVzc2FnZS5sZW5ndGggPCAyNTAgPyBwYXlsb2FkIDogYHsuLi59YCk7XG4gICAgICAgIHJldHVybiB7aGVhZGVyLCBwYXlsb2FkfTtcbiAgICB9XG5cbiAgICBjb25zdCBjbGllbnRzID0gbmV3IFNldDxXZWJTb2NrZXQ+KCk7XG5cbiAgICB3c3Mub24oXCJjb25uZWN0aW9uXCIsIHdzID0+IHtcblxuICAgICAgICB3cy5vbihcIm1lc3NhZ2VcIiwgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7aGVhZGVyLCBwYXlsb2FkfSA9IHVubWFyc2hhbGwobWVzc2FnZSk7XG4gICAgICAgICAgICBjb25zdCBsaXN0ZW5lciA9IGxpc3RlbmVycy5nZXQoaGVhZGVyKTtcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lcikge1xuICAgICAgICAgICAgICAgIGxpc3RlbmVyLmNhbGwobGlzdGVuZXJzLCBwYXlsb2FkLCAoaGVhZGVyLCBwYXlsb2FkKSA9PiB3cy5zZW5kKG1hcnNoYWxsKGhlYWRlciwgcGF5bG9hZCkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgd3Muc2VuZChcImNvbm5lY3RlZDpcIiArIEpTT04uc3RyaW5naWZ5KHtzaW5jZTogbmV3IERhdGUoKS50b1VUQ1N0cmluZygpfSkpO1xuXG4gICAgICAgIGNsaWVudHMuYWRkKHdzKTtcblxuICAgICAgICB3cy5vbihcImNsb3NlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGNsaWVudHMuZGVsZXRlKHdzKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBicm9hZGNhc3QoaGVhZGVyOnN0cmluZywgcGF5bG9hZDphbnkpIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSBtYXJzaGFsbChoZWFkZXIsIHBheWxvYWQpO1xuICAgICAgICBmb3IgKGNvbnN0IGNsaWVudCBvZiBjbGllbnRzKSB7XG4gICAgICAgICAgICBjbGllbnQuc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5vdGlmaWNhdGlvbnMub24oXCJuZXdcIiwgKG5vdGlmaWNhdGlvbjpXZWJNb2R1bGVzTm90aWZpY2F0aW9uKSA9PiB7XG4gICAgICAgIGJyb2FkY2FzdChcIm5vdGlmaWNhdGlvbjpuZXdcIiwgbm90aWZpY2F0aW9uKTtcbiAgICB9KTtcblxuICAgIG5vdGlmaWNhdGlvbnMub24oXCJ1cGRhdGVcIiwgKG5vdGlmaWNhdGlvbjpXZWJNb2R1bGVzTm90aWZpY2F0aW9uKSA9PiB7XG4gICAgICAgIGJyb2FkY2FzdChcIm5vdGlmaWNhdGlvbjp1cGRhdGVcIiwgbm90aWZpY2F0aW9uKTtcbiAgICB9KTtcbn1cbiJdfQ==