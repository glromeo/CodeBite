"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useMessaging = void 0;
const chalk_1 = __importDefault(require("chalk"));
const esnext_web_modules_1 = require("esnext-web-modules");
const nano_memoize_1 = __importDefault(require("nano-memoize"));
const tiny_node_logger_1 = __importDefault(require("tiny-node-logger"));
const ws_1 = __importDefault(require("ws"));
const multi_map_1 = require("./util/multi-map");
const watcher_1 = require("./watcher");
exports.useMessaging = nano_memoize_1.default((options) => {
    var _a, _b;
    const sockets = new Set();
    function broadcast(type, data) {
        const message = data === undefined ? type : JSON.stringify({ type, data });
        for (const ws of sockets) {
            ws.send(message);
        }
    }
    const callbacks = new multi_map_1.MultiMap();
    function on(type, cb) {
        callbacks.add(type, cb);
        tiny_node_logger_1.default.debug("added message listener for:", chalk_1.default.magenta(type));
    }
    const watcher = watcher_1.useWatcher(options);
    for (const plugin of (_b = (_a = options.messaging) === null || _a === void 0 ? void 0 : _a.plugins) !== null && _b !== void 0 ? _b : []) {
        plugin({ on, broadcast, options, watcher });
    }
    function openCallback(ws) {
        function send(type, data) {
            const message = data === undefined ? type : JSON.stringify({ type, data });
            return ws.send(message);
        }
        tiny_node_logger_1.default.debug("client connected:", ws.url);
        sockets.add(ws);
        ws.on("error", () => {
            tiny_node_logger_1.default.debug("client error:", ws.url);
        });
        ws.on("close", () => {
            tiny_node_logger_1.default.debug("client disconnected:", ws.url);
            sockets.delete(ws);
        });
        ws.on("message", function (message) {
            const { type, data } = message.charAt(0) === "{" ? JSON.parse(message) : { type: message };
            if (callbacks.has(type))
                for (const callback of callbacks.get(type)) {
                    callback(data, send);
                }
        });
        ws.send(JSON.stringify({ type: "hello", data: { time: new Date().toUTCString() } }));
    }
    function errorCallback(error) {
        tiny_node_logger_1.default.error("websocket error:", error);
    }
    function closeCallback() {
        tiny_node_logger_1.default.info("websocket closed");
    }
    esnext_web_modules_1.notifications.on("create", (notification) => {
        broadcast("notification:new", notification);
    });
    esnext_web_modules_1.notifications.on("update", (notification) => {
        broadcast("notification:update", notification);
    });
    return {
        handleUpgrade(req, socket, head) {
            if (req.headers["sec-websocket-protocol"] === "esnext-dev") {
                const wss = new ws_1.default.Server({ noServer: true });
                wss.on("open", openCallback);
                wss.on("error", errorCallback);
                wss.on("close", closeCallback);
                wss.handleUpgrade(req, socket, head, client => wss.emit("open", client, req));
                tiny_node_logger_1.default.info("websocket ready");
            }
        },
        broadcast
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21lc3NhZ2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxrREFBMEI7QUFFMUIsMkRBQXlFO0FBQ3pFLGdFQUFvQztBQUNwQyx3RUFBbUM7QUFDbkMsNENBQTJCO0FBRTNCLGdEQUEwQztBQUMxQyx1Q0FBcUM7QUFZeEIsUUFBQSxZQUFZLEdBQUcsc0JBQVEsQ0FBQyxDQUFDLE9BQXNCLEVBQUUsRUFBRTs7SUFFNUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQWEsQ0FBQztJQUVyQyxTQUFTLFNBQVMsQ0FBQyxJQUFZLEVBQUUsSUFBVTtRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN6RSxLQUFLLE1BQU0sRUFBRSxJQUFJLE9BQU8sRUFBRTtZQUN0QixFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQztJQUVELE1BQU0sU0FBUyxHQUFHLElBQUksb0JBQVEsRUFBMkIsQ0FBQztJQUUxRCxTQUFTLEVBQUUsQ0FBQyxJQUFZLEVBQUUsRUFBbUI7UUFDekMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEIsMEJBQUcsQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsZUFBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxvQkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXBDLEtBQUssTUFBTSxNQUFNLElBQUksTUFBQSxNQUFBLE9BQU8sQ0FBQyxTQUFTLDBDQUFFLE9BQU8sbUNBQUksRUFBRSxFQUFFO1FB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QUcsSUFBSSxZQUFTLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7Z0JBQ25ELEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUM3QixHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztnQkFDL0IsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7Z0JBQy9CLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDOUUsMEJBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQzthQUMvQjtRQUNMLENBQUM7UUFDRCxTQUFTO0tBQ1osQ0FBQztBQUNOLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiO1xuaW1wb3J0IHtGU1dhdGNoZXJ9IGZyb20gXCJjaG9raWRhclwiO1xuaW1wb3J0IHtub3RpZmljYXRpb25zLCBXZWJNb2R1bGVzTm90aWZpY2F0aW9ufSBmcm9tIFwiZXNuZXh0LXdlYi1tb2R1bGVzXCI7XG5pbXBvcnQgbWVtb2l6ZWQgZnJvbSBcIm5hbm8tbWVtb2l6ZVwiO1xuaW1wb3J0IGxvZyBmcm9tIFwidGlueS1ub2RlLWxvZ2dlclwiO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tIFwid3NcIjtcbmltcG9ydCB7RVNOZXh0T3B0aW9uc30gZnJvbSBcIi4vY29uZmlndXJlXCI7XG5pbXBvcnQge011bHRpTWFwfSBmcm9tIFwiLi91dGlsL211bHRpLW1hcFwiO1xuaW1wb3J0IHt1c2VXYXRjaGVyfSBmcm9tIFwiLi93YXRjaGVyXCI7XG5cbmV4cG9ydCB0eXBlIE1lc3NhZ2UgPSB7IHR5cGU6IHN0cmluZywgZGF0YT86IGFueSB9O1xuZXhwb3J0IHR5cGUgU2VuZE1lc3NhZ2UgPSAodHlwZTogc3RyaW5nLCBkYXRhPzogYW55KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgTWVzc2FnZUNhbGxiYWNrID0gKGRhdGE6IGFueSwgc2VuZDogU2VuZE1lc3NhZ2UpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSBPbk1lc3NhZ2UgPSAodHlwZTogc3RyaW5nLCBjYjogTWVzc2FnZUNhbGxiYWNrKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgTWVzc2FnaW5nQ29udGV4dCA9IHsgb246IE9uTWVzc2FnZSwgYnJvYWRjYXN0OiBTZW5kTWVzc2FnZSwgb3B0aW9uczogRVNOZXh0T3B0aW9ucywgd2F0Y2hlcjogRlNXYXRjaGVyIH07XG5leHBvcnQgdHlwZSBNZXNzYWdpbmdFbmRwb2ludCA9IChtZXNzYWdpbmdDb250ZXh0OiBNZXNzYWdpbmdDb250ZXh0KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgTWVzc2FnaW5nT3B0aW9ucyA9IHtcbiAgICBwbHVnaW5zPzogKE1lc3NhZ2luZ0VuZHBvaW50KVtdXG59XG5cbmV4cG9ydCBjb25zdCB1c2VNZXNzYWdpbmcgPSBtZW1vaXplZCgob3B0aW9uczogRVNOZXh0T3B0aW9ucykgPT4ge1xuXG4gICAgY29uc3Qgc29ja2V0cyA9IG5ldyBTZXQ8V2ViU29ja2V0PigpO1xuXG4gICAgZnVuY3Rpb24gYnJvYWRjYXN0KHR5cGU6IHN0cmluZywgZGF0YT86IGFueSkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gZGF0YSA9PT0gdW5kZWZpbmVkID8gdHlwZSA6IEpTT04uc3RyaW5naWZ5KHt0eXBlLCBkYXRhfSk7XG4gICAgICAgIGZvciAoY29uc3Qgd3Mgb2Ygc29ja2V0cykge1xuICAgICAgICAgICAgd3Muc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGNhbGxiYWNrcyA9IG5ldyBNdWx0aU1hcDxzdHJpbmcsIE1lc3NhZ2VDYWxsYmFjaz4oKTtcblxuICAgIGZ1bmN0aW9uIG9uKHR5cGU6IHN0cmluZywgY2I6IE1lc3NhZ2VDYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFja3MuYWRkKHR5cGUsIGNiKTtcbiAgICAgICAgbG9nLmRlYnVnKFwiYWRkZWQgbWVzc2FnZSBsaXN0ZW5lciBmb3I6XCIsIGNoYWxrLm1hZ2VudGEodHlwZSkpO1xuICAgIH1cblxuICAgIGNvbnN0IHdhdGNoZXIgPSB1c2VXYXRjaGVyKG9wdGlvbnMpO1xuXG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2Ygb3B0aW9ucy5tZXNzYWdpbmc/LnBsdWdpbnMgPz8gW10pIHtcbiAgICAgICAgcGx1Z2luKHtvbiwgYnJvYWRjYXN0LCBvcHRpb25zLCB3YXRjaGVyfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gb3BlbkNhbGxiYWNrKHdzOiBXZWJTb2NrZXQpIHtcblxuICAgICAgICBmdW5jdGlvbiBzZW5kKHR5cGU6IHN0cmluZywgZGF0YT86IGFueSkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGRhdGEgPT09IHVuZGVmaW5lZCA/IHR5cGUgOiBKU09OLnN0cmluZ2lmeSh7dHlwZSwgZGF0YX0pO1xuICAgICAgICAgICAgcmV0dXJuIHdzLnNlbmQobWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsb2cuZGVidWcoXCJjbGllbnQgY29ubmVjdGVkOlwiLCB3cy51cmwpO1xuICAgICAgICBzb2NrZXRzLmFkZCh3cyk7XG5cbiAgICAgICAgd3Mub24oXCJlcnJvclwiLCAoKSA9PiB7XG4gICAgICAgICAgICBsb2cuZGVidWcoXCJjbGllbnQgZXJyb3I6XCIsIHdzLnVybCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHdzLm9uKFwiY2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICAgICAgbG9nLmRlYnVnKFwiY2xpZW50IGRpc2Nvbm5lY3RlZDpcIiwgd3MudXJsKTtcbiAgICAgICAgICAgIHNvY2tldHMuZGVsZXRlKHdzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgd3Mub24oXCJtZXNzYWdlXCIsIGZ1bmN0aW9uIChtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHt0eXBlLCBkYXRhfTogTWVzc2FnZSA9IG1lc3NhZ2UuY2hhckF0KDApID09PSBcIntcIiA/IEpTT04ucGFyc2UobWVzc2FnZSkgOiB7dHlwZTogbWVzc2FnZX07XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2tzLmhhcyh0eXBlKSkgZm9yIChjb25zdCBjYWxsYmFjayBvZiBjYWxsYmFja3MuZ2V0KHR5cGUpISkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEsIHNlbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KHt0eXBlOiBcImhlbGxvXCIsIGRhdGE6IHt0aW1lOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCl9fSkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGVycm9yQ2FsbGJhY2soZXJyb3IpIHtcbiAgICAgICAgbG9nLmVycm9yKFwid2Vic29ja2V0IGVycm9yOlwiLCBlcnJvcik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY2xvc2VDYWxsYmFjaygpIHtcbiAgICAgICAgbG9nLmluZm8oXCJ3ZWJzb2NrZXQgY2xvc2VkXCIpO1xuICAgIH1cblxuICAgIG5vdGlmaWNhdGlvbnMub24oXCJjcmVhdGVcIiwgKG5vdGlmaWNhdGlvbjogV2ViTW9kdWxlc05vdGlmaWNhdGlvbikgPT4ge1xuICAgICAgICBicm9hZGNhc3QoXCJub3RpZmljYXRpb246bmV3XCIsIG5vdGlmaWNhdGlvbik7XG4gICAgfSk7XG5cbiAgICBub3RpZmljYXRpb25zLm9uKFwidXBkYXRlXCIsIChub3RpZmljYXRpb246IFdlYk1vZHVsZXNOb3RpZmljYXRpb24pID0+IHtcbiAgICAgICAgYnJvYWRjYXN0KFwibm90aWZpY2F0aW9uOnVwZGF0ZVwiLCBub3RpZmljYXRpb24pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaGFuZGxlVXBncmFkZShyZXEsIHNvY2tldCwgaGVhZCkge1xuICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzW1wic2VjLXdlYnNvY2tldC1wcm90b2NvbFwiXSA9PT0gXCJlc25leHQtZGV2XCIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7bm9TZXJ2ZXI6IHRydWV9KTtcbiAgICAgICAgICAgICAgICB3c3Mub24oXCJvcGVuXCIsIG9wZW5DYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgd3NzLm9uKFwiZXJyb3JcIiwgZXJyb3JDYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgd3NzLm9uKFwiY2xvc2VcIiwgY2xvc2VDYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgd3NzLmhhbmRsZVVwZ3JhZGUocmVxLCBzb2NrZXQsIGhlYWQsIGNsaWVudCA9PiB3c3MuZW1pdChcIm9wZW5cIiwgY2xpZW50LCByZXEpKTtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIndlYnNvY2tldCByZWFkeVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgYnJvYWRjYXN0XG4gICAgfTtcbn0pO1xuIl19