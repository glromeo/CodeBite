"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useHotModuleReplacement = exports.EsmHmrEngine = void 0;
const pico_memoize_1 = __importDefault(require("pico-memoize"));
const ws_1 = __importDefault(require("ws"));
class EsmHmrEngine {
    constructor(server) {
        this.clients = new Set();
        this.dependencyTree = new Map();
        const wss = new ws_1.default.Server({ noServer: true });
        server.on("upgrade", (req, socket, head) => {
            if (req.headers["sec-websocket-protocol"] === "esm-hmr") {
                wss.handleUpgrade(req, socket, head, (client) => {
                    wss.emit("connection", client, req);
                });
            }
        });
        wss.on("connection", (client) => {
            this.connectClient(client);
            this.registerListener(client);
        });
    }
    registerListener(client) {
        client.on("message", (data) => {
            const message = JSON.parse(data.toString());
            if (message.type === "hotAccept") {
                const entry = this.getEntry(message.id, true);
                entry.isHmrAccepted = true;
            }
        });
    }
    createEntry(sourceUrl) {
        const newEntry = {
            dependencies: new Set(),
            dependents: new Set(),
            needsReplacement: false,
            isHmrEnabled: false,
            isHmrAccepted: false
        };
        this.dependencyTree.set(sourceUrl, newEntry);
        return newEntry;
    }
    getEntry(sourceUrl, createIfNotFound = false) {
        const result = this.dependencyTree.get(sourceUrl);
        if (result) {
            return result;
        }
        if (createIfNotFound) {
            return this.createEntry(sourceUrl);
        }
        return null;
    }
    setEntry(sourceUrl, imports, isHmrEnabled = false) {
        const result = this.getEntry(sourceUrl, true);
        const outdatedDependencies = new Set(result.dependencies);
        result.isHmrEnabled = isHmrEnabled;
        for (const importUrl of imports) {
            this.addRelationship(sourceUrl, importUrl);
            outdatedDependencies.delete(importUrl);
        }
        for (const importUrl of outdatedDependencies) {
            this.removeRelationship(sourceUrl, importUrl);
        }
    }
    removeRelationship(sourceUrl, importUrl) {
        let importResult = this.getEntry(importUrl);
        importResult && importResult.dependents.delete(sourceUrl);
        const sourceResult = this.getEntry(sourceUrl);
        sourceResult && sourceResult.dependencies.delete(importUrl);
    }
    addRelationship(sourceUrl, importUrl) {
        if (importUrl !== sourceUrl) {
            let importResult = this.getEntry(importUrl, true);
            importResult.dependents.add(sourceUrl);
            const sourceResult = this.getEntry(sourceUrl, true);
            sourceResult.dependencies.add(importUrl);
        }
    }
    markEntryForReplacement(entry, state) {
        entry.needsReplacement = state;
    }
    broadcastMessage(data) {
        this.clients.forEach((client) => {
            if (client.readyState === ws_1.default.OPEN) {
                client.send(JSON.stringify(data));
            }
            else {
                this.disconnectClient(client);
            }
        });
    }
    connectClient(client) {
        this.clients.add(client);
    }
    disconnectClient(client) {
        client.terminate();
        this.clients.delete(client);
    }
    disconnectAllClients() {
        for (const client of this.clients) {
            this.disconnectClient(client);
        }
    }
}
exports.EsmHmrEngine = EsmHmrEngine;
exports.useHotModuleReplacement = pico_memoize_1.default(function (options) {
    return {
        engine: null,
        connect(server) {
            this.engine = new EsmHmrEngine(server);
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLXNlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9obXItc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLGdFQUFtQztBQUNuQyw0Q0FBMkI7QUFXM0IsTUFBYSxZQUFZO0lBSXJCLFlBQVksTUFBaUM7UUFIN0MsWUFBTyxHQUFtQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFHM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFTLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDbkQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3ZDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDckQsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO29CQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsTUFBaUI7UUFDOUIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZ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QzNDLENBQUM7S0FDSixDQUFBO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQge0h0dHAyU2VydmVyfSBmcm9tIFwiaHR0cDJcIjtcbmltcG9ydCBtZW1vaXplIGZyb20gXCJwaWNvLW1lbW9pemVcIjtcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSBcIndzXCI7XG5pbXBvcnQge0VTTmV4dE9wdGlvbnN9IGZyb20gXCIuL2NvbmZpZ3VyZVwiO1xuXG5pbnRlcmZhY2UgRGVwZW5kZW5jeSB7XG4gICAgZGVwZW5kZW50czogU2V0PHN0cmluZz47XG4gICAgZGVwZW5kZW5jaWVzOiBTZXQ8c3RyaW5nPjtcbiAgICBpc0htckVuYWJsZWQ6IGJvb2xlYW47XG4gICAgaXNIbXJBY2NlcHRlZDogYm9vbGVhbjtcbiAgICBuZWVkc1JlcGxhY2VtZW50OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgRXNtSG1yRW5naW5lIHtcbiAgICBjbGllbnRzOiBTZXQ8V2ViU29ja2V0PiA9IG5ldyBTZXQoKTtcbiAgICBkZXBlbmRlbmN5VHJlZSA9IG5ldyBNYXA8c3RyaW5nLCBEZXBlbmRlbmN5PigpO1xuXG4gICAgY29uc3RydWN0b3Ioc2VydmVyOiBodHRwLlNlcnZlciB8IEh0dHAyU2VydmVyKSB7XG4gICAgICAgIGNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHtub1NlcnZlcjogdHJ1ZX0pO1xuICAgICAgICBzZXJ2ZXIub24oXCJ1cGdyYWRlXCIsIChyZXEsIHNvY2tldCwgaGVhZCkgPT4ge1xuICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzW1wic2VjLXdlYnNvY2tldC1wcm90b2NvbFwiXSA9PT0gXCJlc20taG1yXCIpIHtcbiAgICAgICAgICAgICAgICB3c3MuaGFuZGxlVXBncmFkZShyZXEsIHNvY2tldCwgaGVhZCwgKGNsaWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB3c3MuZW1pdChcImNvbm5lY3Rpb25cIiwgY2xpZW50LCByZXEpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgd3NzLm9uKFwiY29ubmVjdGlvblwiLCAoY2xpZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3RDbGllbnQoY2xpZW50KTtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJMaXN0ZW5lcihjbGllbnQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZWdpc3Rlckxpc3RlbmVyKGNsaWVudDogV2ViU29ja2V0KSB7XG4gICAgICAgIGNsaWVudC5vbihcIm1lc3NhZ2VcIiwgKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSBcImhvdEFjY2VwdFwiKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSB0aGlzLmdldEVudHJ5KG1lc3NhZ2UuaWQsIHRydWUpIGFzIERlcGVuZGVuY3k7XG4gICAgICAgICAgICAgICAgZW50cnkuaXNIbXJBY2NlcHRlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNyZWF0ZUVudHJ5KHNvdXJjZVVybDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG5ld0VudHJ5OiBEZXBlbmRlbmN5ID0ge1xuICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiBuZXcgU2V0KCksXG4gICAgICAgICAgICBkZXBlbmRlbnRzOiBuZXcgU2V0KCksXG4gICAgICAgICAgICBuZWVkc1JlcGxhY2VtZW50OiBmYWxzZSxcbiAgICAgICAgICAgIGlzSG1yRW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBpc0htckFjY2VwdGVkOiBmYWxzZVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmVlLnNldChzb3VyY2VVcmwsIG5ld0VudHJ5KTtcbiAgICAgICAgcmV0dXJuIG5ld0VudHJ5O1xuICAgIH1cblxuICAgIGdldEVudHJ5KHNvdXJjZVVybDogc3RyaW5nLCBjcmVhdGVJZk5vdEZvdW5kID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kZXBlbmRlbmN5VHJlZS5nZXQoc291cmNlVXJsKTtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY3JlYXRlSWZOb3RGb3VuZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRW50cnkoc291cmNlVXJsKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBzZXRFbnRyeShzb3VyY2VVcmw6IHN0cmluZywgaW1wb3J0czogc3RyaW5nW10sIGlzSG1yRW5hYmxlZCA9IGZhbHNlKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZ2V0RW50cnkoc291cmNlVXJsLCB0cnVlKSE7XG4gICAgICAgIGNvbnN0IG91dGRhdGVkRGVwZW5kZW5jaWVzID0gbmV3IFNldChyZXN1bHQuZGVwZW5kZW5jaWVzKTtcbiAgICAgICAgcmVzdWx0LmlzSG1yRW5hYmxlZCA9IGlzSG1yRW5hYmxlZDtcbiAgICAgICAgZm9yIChjb25zdCBpbXBvcnRVcmwgb2YgaW1wb3J0cykge1xuICAgICAgICAgICAgdGhpcy5hZGRSZWxhdGlvbnNoaXAoc291cmNlVXJsLCBpbXBvcnRVcmwpO1xuICAgICAgICAgICAgb3V0ZGF0ZWREZXBlbmRlbmNpZXMuZGVsZXRlKGltcG9ydFVybCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBpbXBvcnRVcmwgb2Ygb3V0ZGF0ZWREZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlUmVsYXRpb25zaGlwKHNvdXJjZVVybCwgaW1wb3J0VXJsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJlbW92ZVJlbGF0aW9uc2hpcChzb3VyY2VVcmw6IHN0cmluZywgaW1wb3J0VXJsOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGltcG9ydFJlc3VsdCA9IHRoaXMuZ2V0RW50cnkoaW1wb3J0VXJsKTtcbiAgICAgICAgaW1wb3J0UmVzdWx0ICYmIGltcG9ydFJlc3VsdC5kZXBlbmRlbnRzLmRlbGV0ZShzb3VyY2VVcmwpO1xuICAgICAgICBjb25zdCBzb3VyY2VSZXN1bHQgPSB0aGlzLmdldEVudHJ5KHNvdXJjZVVybCk7XG4gICAgICAgIHNvdXJjZVJlc3VsdCAmJiBzb3VyY2VSZXN1bHQuZGVwZW5kZW5jaWVzLmRlbGV0ZShpbXBvcnRVcmwpO1xuICAgIH1cblxuICAgIGFkZFJlbGF0aW9uc2hpcChzb3VyY2VVcmw6IHN0cmluZywgaW1wb3J0VXJsOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGltcG9ydFVybCAhPT0gc291cmNlVXJsKSB7XG4gICAgICAgICAgICBsZXQgaW1wb3J0UmVzdWx0ID0gdGhpcy5nZXRFbnRyeShpbXBvcnRVcmwsIHRydWUpITtcbiAgICAgICAgICAgIGltcG9ydFJlc3VsdC5kZXBlbmRlbnRzLmFkZChzb3VyY2VVcmwpO1xuICAgICAgICAgICAgY29uc3Qgc291cmNlUmVzdWx0ID0gdGhpcy5nZXRFbnRyeShzb3VyY2VVcmwsIHRydWUpITtcbiAgICAgICAgICAgIHNvdXJjZVJlc3VsdC5kZXBlbmRlbmNpZXMuYWRkKGltcG9ydFVybCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrRW50cnlGb3JSZXBsYWNlbWVudChlbnRyeTogRGVwZW5kZW5jeSwgc3RhdGU6IGJvb2xlYW4pIHtcbiAgICAgICAgZW50cnkubmVlZHNSZXBsYWNlbWVudCA9IHN0YXRlO1xuICAgIH1cblxuICAgIGJyb2FkY2FzdE1lc3NhZ2UoZGF0YTogb2JqZWN0KSB7XG4gICAgICAgIHRoaXMuY2xpZW50cy5mb3JFYWNoKChjbGllbnQpID0+IHtcbiAgICAgICAgICAgIGlmIChjbGllbnQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICAgICAgICBjbGllbnQuc2VuZChKU09OLnN0cmluZ2lmeShkYXRhKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdENsaWVudChjbGllbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25uZWN0Q2xpZW50KGNsaWVudDogV2ViU29ja2V0KSB7XG4gICAgICAgIHRoaXMuY2xpZW50cy5hZGQoY2xpZW50KTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0Q2xpZW50KGNsaWVudDogV2ViU29ja2V0KSB7XG4gICAgICAgIGNsaWVudC50ZXJtaW5hdGUoKTtcbiAgICAgICAgdGhpcy5jbGllbnRzLmRlbGV0ZShjbGllbnQpO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3RBbGxDbGllbnRzKCkge1xuICAgICAgICBmb3IgKGNvbnN0IGNsaWVudCBvZiB0aGlzLmNsaWVudHMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdENsaWVudChjbGllbnQpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgdHlwZSBIb3RNb2R1bGVSZXBsYWNlbWVudCA9IHtcbiAgICBlbmdpbmU6IEVzbUhtckVuZ2luZXxudWxsXG4gICAgY29ubmVjdChzZXJ2ZXI6aHR0cC5TZXJ2ZXIgfCBIdHRwMlNlcnZlcik6dm9pZFxufVxuXG5leHBvcnQgY29uc3QgdXNlSG90TW9kdWxlUmVwbGFjZW1lbnQgPSBtZW1vaXplKGZ1bmN0aW9uIChvcHRpb25zOiBFU05leHRPcHRpb25zKTpIb3RNb2R1bGVSZXBsYWNlbWVudCB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZW5naW5lOiBudWxsLFxuICAgICAgICBjb25uZWN0KHNlcnZlcikge1xuICAgICAgICAgICAgdGhpcy5lbmdpbmUgPSBuZXcgRXNtSG1yRW5naW5lKHNlcnZlcik7XG4gICAgICAgIH1cbiAgICB9XG59KTsiXX0=