"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useHotModuleReplacement = exports.EsmHmrEngine = void 0;
const pico_memoize_1 = __importDefault(require("pico-memoize"));
const ws_1 = __importDefault(require("ws"));
class EsmHmrEngine {
    constructor(server) {
        this.clients = new Set();
        this.dependencyTree = new Map();
        const wss = new ws_1.default.Server({ noServer: true });
        server.on("upgrade", (req, socket, head) => {
            if (req.headers["sec-websocket-protocol"] === "esm-hmr") {
                wss.handleUpgrade(req, socket, head, (client) => {
                    wss.emit("connection", client, req);
                });
            }
        });
        wss.on("connection", (client) => {
            this.connectClient(client);
            this.registerListener(client);
        });
    }
    registerListener(client) {
        client.on("message", (data) => {
            const message = JSON.parse(data.toString());
            if (message.type === "hotAccept") {
                const entry = this.getEntry(message.id, true);
                entry.isHmrAccepted = true;
            }
        });
    }
    createEntry(sourceUrl) {
        const newEntry = {
            dependencies: new Set(),
            dependents: new Set(),
            needsReplacement: false,
            isHmrEnabled: false,
            isHmrAccepted: false
        };
        this.dependencyTree.set(sourceUrl, newEntry);
        return newEntry;
    }
    getEntry(sourceUrl, createIfNotFound = false) {
        const result = this.dependencyTree.get(sourceUrl);
        if (result) {
            return result;
        }
        if (createIfNotFound) {
            return this.createEntry(sourceUrl);
        }
        return null;
    }
    setEntry(sourceUrl, imports, isHmrEnabled = false) {
        const result = this.getEntry(sourceUrl, true);
        const outdatedDependencies = new Set(result.dependencies);
        result.isHmrEnabled = isHmrEnabled;
        for (const importUrl of imports) {
            this.addRelationship(sourceUrl, importUrl);
            outdatedDependencies.delete(importUrl);
        }
        for (const importUrl of outdatedDependencies) {
            this.removeRelationship(sourceUrl, importUrl);
        }
    }
    removeRelationship(sourceUrl, importUrl) {
        let importResult = this.getEntry(importUrl);
        importResult && importResult.dependents.delete(sourceUrl);
        const sourceResult = this.getEntry(sourceUrl);
        sourceResult && sourceResult.dependencies.delete(importUrl);
    }
    addRelationship(sourceUrl, importUrl) {
        if (importUrl !== sourceUrl) {
            let importResult = this.getEntry(importUrl, true);
            importResult.dependents.add(sourceUrl);
            const sourceResult = this.getEntry(sourceUrl, true);
            sourceResult.dependencies.add(importUrl);
        }
    }
    markEntryForReplacement(entry, state) {
        entry.needsReplacement = state;
    }
    broadcastMessage(data) {
        this.clients.forEach((client) => {
            if (client.readyState === ws_1.default.OPEN) {
                client.send(JSON.stringify(data));
            }
            else {
                this.disconnectClient(client);
            }
        });
    }
    connectClient(client) {
        this.clients.add(client);
    }
    disconnectClient(client) {
        client.terminate();
        this.clients.delete(client);
    }
    disconnectAllClients() {
        for (const client of this.clients) {
            this.disconnectClient(client);
        }
    }
}
exports.EsmHmrEngine = EsmHmrEngine;
exports.useHotModuleReplacement = pico_memoize_1.default(function (options) {
    return {
        engine: null,
        connect(server) {
            this.engine = new EsmHmrEngine(server);
            server.on("close", () => {
                this.engine.disconnectAllClients();
            });
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLXNlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9obXItc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLGdFQUFtQztBQUNuQyw0Q0FBMkI7QUFXM0IsTUFBYSxZQUFZO0lBSXJCLFlBQVksTUFBaUM7UUFIN0MsWUFBTyxHQUFtQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFHM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFTLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDbkQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3ZDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDckQsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO29CQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsTUFBaUI7UUFDOUIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZ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Q3ZDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtnQkFDcEIsSUFBSSxDQUFDLE1BQU8sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKLENBQUE7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIGh0dHAgZnJvbSBcImh0dHBcIjtcbmltcG9ydCB7SHR0cDJTZXJ2ZXJ9IGZyb20gXCJodHRwMlwiO1xuaW1wb3J0IG1lbW9pemUgZnJvbSBcInBpY28tbWVtb2l6ZVwiO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tIFwid3NcIjtcbmltcG9ydCB7RVNOZXh0T3B0aW9uc30gZnJvbSBcIi4vY29uZmlndXJlXCI7XG5cbmludGVyZmFjZSBEZXBlbmRlbmN5IHtcbiAgICBkZXBlbmRlbnRzOiBTZXQ8c3RyaW5nPjtcbiAgICBkZXBlbmRlbmNpZXM6IFNldDxzdHJpbmc+O1xuICAgIGlzSG1yRW5hYmxlZDogYm9vbGVhbjtcbiAgICBpc0htckFjY2VwdGVkOiBib29sZWFuO1xuICAgIG5lZWRzUmVwbGFjZW1lbnQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBFc21IbXJFbmdpbmUge1xuICAgIGNsaWVudHM6IFNldDxXZWJTb2NrZXQ+ID0gbmV3IFNldCgpO1xuICAgIGRlcGVuZGVuY3lUcmVlID0gbmV3IE1hcDxzdHJpbmcsIERlcGVuZGVuY3k+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihzZXJ2ZXI6IGh0dHAuU2VydmVyIHwgSHR0cDJTZXJ2ZXIpIHtcbiAgICAgICAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe25vU2VydmVyOiB0cnVlfSk7XG4gICAgICAgIHNlcnZlci5vbihcInVwZ3JhZGVcIiwgKHJlcSwgc29ja2V0LCBoZWFkKSA9PiB7XG4gICAgICAgICAgICBpZiAocmVxLmhlYWRlcnNbXCJzZWMtd2Vic29ja2V0LXByb3RvY29sXCJdID09PSBcImVzbS1obXJcIikge1xuICAgICAgICAgICAgICAgIHdzcy5oYW5kbGVVcGdyYWRlKHJlcSwgc29ja2V0LCBoZWFkLCAoY2xpZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHdzcy5lbWl0KFwiY29ubmVjdGlvblwiLCBjbGllbnQsIHJlcSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB3c3Mub24oXCJjb25uZWN0aW9uXCIsIChjbGllbnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdENsaWVudChjbGllbnQpO1xuICAgICAgICAgICAgdGhpcy5yZWdpc3Rlckxpc3RlbmVyKGNsaWVudCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlZ2lzdGVyTGlzdGVuZXIoY2xpZW50OiBXZWJTb2NrZXQpIHtcbiAgICAgICAgY2xpZW50Lm9uKFwibWVzc2FnZVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09IFwiaG90QWNjZXB0XCIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0RW50cnkobWVzc2FnZS5pZCwgdHJ1ZSkgYXMgRGVwZW5kZW5jeTtcbiAgICAgICAgICAgICAgICBlbnRyeS5pc0htckFjY2VwdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY3JlYXRlRW50cnkoc291cmNlVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgbmV3RW50cnk6IERlcGVuZGVuY3kgPSB7XG4gICAgICAgICAgICBkZXBlbmRlbmNpZXM6IG5ldyBTZXQoKSxcbiAgICAgICAgICAgIGRlcGVuZGVudHM6IG5ldyBTZXQoKSxcbiAgICAgICAgICAgIG5lZWRzUmVwbGFjZW1lbnQ6IGZhbHNlLFxuICAgICAgICAgICAgaXNIbXJFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgIGlzSG1yQWNjZXB0ZWQ6IGZhbHNlXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyZWUuc2V0KHNvdXJjZVVybCwgbmV3RW50cnkpO1xuICAgICAgICByZXR1cm4gbmV3RW50cnk7XG4gICAgfVxuXG4gICAgZ2V0RW50cnkoc291cmNlVXJsOiBzdHJpbmcsIGNyZWF0ZUlmTm90Rm91bmQgPSBmYWxzZSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmRlcGVuZGVuY3lUcmVlLmdldChzb3VyY2VVcmwpO1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChjcmVhdGVJZk5vdEZvdW5kKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVFbnRyeShzb3VyY2VVcmwpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHNldEVudHJ5KHNvdXJjZVVybDogc3RyaW5nLCBpbXBvcnRzOiBzdHJpbmdbXSwgaXNIbXJFbmFibGVkID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5nZXRFbnRyeShzb3VyY2VVcmwsIHRydWUpITtcbiAgICAgICAgY29uc3Qgb3V0ZGF0ZWREZXBlbmRlbmNpZXMgPSBuZXcgU2V0KHJlc3VsdC5kZXBlbmRlbmNpZXMpO1xuICAgICAgICByZXN1bHQuaXNIbXJFbmFibGVkID0gaXNIbXJFbmFibGVkO1xuICAgICAgICBmb3IgKGNvbnN0IGltcG9ydFVybCBvZiBpbXBvcnRzKSB7XG4gICAgICAgICAgICB0aGlzLmFkZFJlbGF0aW9uc2hpcChzb3VyY2VVcmwsIGltcG9ydFVybCk7XG4gICAgICAgICAgICBvdXRkYXRlZERlcGVuZGVuY2llcy5kZWxldGUoaW1wb3J0VXJsKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IGltcG9ydFVybCBvZiBvdXRkYXRlZERlcGVuZGVuY2llcykge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVSZWxhdGlvbnNoaXAoc291cmNlVXJsLCBpbXBvcnRVcmwpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVtb3ZlUmVsYXRpb25zaGlwKHNvdXJjZVVybDogc3RyaW5nLCBpbXBvcnRVcmw6IHN0cmluZykge1xuICAgICAgICBsZXQgaW1wb3J0UmVzdWx0ID0gdGhpcy5nZXRFbnRyeShpbXBvcnRVcmwpO1xuICAgICAgICBpbXBvcnRSZXN1bHQgJiYgaW1wb3J0UmVzdWx0LmRlcGVuZGVudHMuZGVsZXRlKHNvdXJjZVVybCk7XG4gICAgICAgIGNvbnN0IHNvdXJjZVJlc3VsdCA9IHRoaXMuZ2V0RW50cnkoc291cmNlVXJsKTtcbiAgICAgICAgc291cmNlUmVzdWx0ICYmIHNvdXJjZVJlc3VsdC5kZXBlbmRlbmNpZXMuZGVsZXRlKGltcG9ydFVybCk7XG4gICAgfVxuXG4gICAgYWRkUmVsYXRpb25zaGlwKHNvdXJjZVVybDogc3RyaW5nLCBpbXBvcnRVcmw6IHN0cmluZykge1xuICAgICAgICBpZiAoaW1wb3J0VXJsICE9PSBzb3VyY2VVcmwpIHtcbiAgICAgICAgICAgIGxldCBpbXBvcnRSZXN1bHQgPSB0aGlzLmdldEVudHJ5KGltcG9ydFVybCwgdHJ1ZSkhO1xuICAgICAgICAgICAgaW1wb3J0UmVzdWx0LmRlcGVuZGVudHMuYWRkKHNvdXJjZVVybCk7XG4gICAgICAgICAgICBjb25zdCBzb3VyY2VSZXN1bHQgPSB0aGlzLmdldEVudHJ5KHNvdXJjZVVybCwgdHJ1ZSkhO1xuICAgICAgICAgICAgc291cmNlUmVzdWx0LmRlcGVuZGVuY2llcy5hZGQoaW1wb3J0VXJsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1hcmtFbnRyeUZvclJlcGxhY2VtZW50KGVudHJ5OiBEZXBlbmRlbmN5LCBzdGF0ZTogYm9vbGVhbikge1xuICAgICAgICBlbnRyeS5uZWVkc1JlcGxhY2VtZW50ID0gc3RhdGU7XG4gICAgfVxuXG4gICAgYnJvYWRjYXN0TWVzc2FnZShkYXRhOiBvYmplY3QpIHtcbiAgICAgICAgdGhpcy5jbGllbnRzLmZvckVhY2goKGNsaWVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNsaWVudC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgICAgICAgIGNsaWVudC5zZW5kKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0Q2xpZW50KGNsaWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbm5lY3RDbGllbnQoY2xpZW50OiBXZWJTb2NrZXQpIHtcbiAgICAgICAgdGhpcy5jbGllbnRzLmFkZChjbGllbnQpO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3RDbGllbnQoY2xpZW50OiBXZWJTb2NrZXQpIHtcbiAgICAgICAgY2xpZW50LnRlcm1pbmF0ZSgpO1xuICAgICAgICB0aGlzLmNsaWVudHMuZGVsZXRlKGNsaWVudCk7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdEFsbENsaWVudHMoKSB7XG4gICAgICAgIGZvciAoY29uc3QgY2xpZW50IG9mIHRoaXMuY2xpZW50cykge1xuICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0Q2xpZW50KGNsaWVudCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCB0eXBlIEhvdE1vZHVsZVJlcGxhY2VtZW50ID0ge1xuICAgIGVuZ2luZTogRXNtSG1yRW5naW5lfG51bGxcbiAgICBjb25uZWN0KHNlcnZlcjpodHRwLlNlcnZlciB8IEh0dHAyU2VydmVyKTp2b2lkXG59XG5cbmV4cG9ydCBjb25zdCB1c2VIb3RNb2R1bGVSZXBsYWNlbWVudCA9IG1lbW9pemUoZnVuY3Rpb24gKG9wdGlvbnM6IEVTTmV4dE9wdGlvbnMpOkhvdE1vZHVsZVJlcGxhY2VtZW50IHtcbiAgICByZXR1cm4ge1xuICAgICAgICBlbmdpbmU6IG51bGwsXG4gICAgICAgIGNvbm5lY3Qoc2VydmVyKSB7XG4gICAgICAgICAgICB0aGlzLmVuZ2luZSA9IG5ldyBFc21IbXJFbmdpbmUoc2VydmVyKTtcbiAgICAgICAgICAgIHNlcnZlci5vbihcImNsb3NlXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVuZ2luZSEuZGlzY29ubmVjdEFsbENsaWVudHMoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufSk7Il19