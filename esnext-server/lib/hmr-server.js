"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useHotModuleReplacement = exports.EsmHmrEngine = void 0;
const pico_memoize_1 = __importDefault(require("pico-memoize"));
const ws_1 = __importDefault(require("ws"));
class EsmHmrEngine {
    constructor(server) {
        this.clients = new Set();
        this.dependencyTree = new Map();
        const wss = new ws_1.default.Server({ noServer: true });
        server.on("upgrade", (req, socket, head) => {
            if (req.headers["sec-websocket-protocol"] === "esm-hmr") {
                wss.handleUpgrade(req, socket, head, (client) => {
                    wss.emit("connection", client, req);
                });
            }
        });
        wss.on("connection", (client) => {
            this.connectClient(client);
            this.registerListener(client);
        });
    }
    registerListener(client) {
        client.on("message", (data) => {
            const message = JSON.parse(data.toString());
            if (message.type === "hotAccept") {
                const entry = this.getEntry(message.id, true);
                entry.isHmrAccepted = true;
            }
        });
    }
    createEntry(sourceUrl) {
        const newEntry = {
            dependencies: new Set(),
            dependents: new Set(),
            needsReplacement: false,
            isHmrEnabled: false,
            isHmrAccepted: false
        };
        this.dependencyTree.set(sourceUrl, newEntry);
        return newEntry;
    }
    getEntry(sourceUrl, createIfNotFound = false) {
        const result = this.dependencyTree.get(sourceUrl);
        if (result) {
            return result;
        }
        if (createIfNotFound) {
            return this.createEntry(sourceUrl);
        }
        return null;
    }
    setEntry(sourceUrl, imports, isHmrEnabled = false) {
        const result = this.getEntry(sourceUrl, true);
        const outdatedDependencies = new Set(result.dependencies);
        result.isHmrEnabled = isHmrEnabled;
        for (const importUrl of imports) {
            this.addRelationship(sourceUrl, importUrl);
            outdatedDependencies.delete(importUrl);
        }
        for (const importUrl of outdatedDependencies) {
            this.removeRelationship(sourceUrl, importUrl);
        }
    }
    removeRelationship(sourceUrl, importUrl) {
        let importResult = this.getEntry(importUrl);
        importResult && importResult.dependents.delete(sourceUrl);
        const sourceResult = this.getEntry(sourceUrl);
        sourceResult && sourceResult.dependencies.delete(importUrl);
    }
    addRelationship(sourceUrl, importUrl) {
        if (importUrl !== sourceUrl) {
            let importResult = this.getEntry(importUrl, true);
            importResult.dependents.add(sourceUrl);
            const sourceResult = this.getEntry(sourceUrl, true);
            sourceResult.dependencies.add(importUrl);
        }
    }
    markEntryForReplacement(entry, state) {
        entry.needsReplacement = state;
    }
    broadcastMessage(data) {
        this.clients.forEach((client) => {
            if (client.readyState === ws_1.default.OPEN) {
                client.send(JSON.stringify(data));
            }
            else {
                this.disconnectClient(client);
            }
        });
    }
    connectClient(client) {
        this.clients.add(client);
    }
    disconnectClient(client) {
        client.terminate();
        this.clients.delete(client);
    }
    disconnectAllClients() {
        for (const client of this.clients) {
            this.disconnectClient(client);
        }
    }
}
exports.EsmHmrEngine = EsmHmrEngine;
exports.useHotModuleReplacement = pico_memoize_1.default(function (options) {
    return {
        engine: null,
        connect(server) {
            this.engine = new EsmHmrEngine(server);
            server.on("close", () => {
                this.engine.disconnectAllClients();
            });
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLXNlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9obXItc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLGdFQUFtQztBQUNuQyw0Q0FBMkI7QUFXM0IsTUFBYSxZQUFZO0lBSXJCLFlBQVksTUFBaUM7UUFIN0MsWUFBTyxHQUFtQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFHM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFTLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDbkQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3ZDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDckQsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO29CQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsTUFBaUI7UUFDOUIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZ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Q3ZDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtnQkFDcEIsSUFBSSxDQUFDLE1BQU8sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKLENBQUE7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuaW1wb3J0IHtIdHRwMlNlcnZlcn0gZnJvbSBcImh0dHAyXCI7XHJcbmltcG9ydCBtZW1vaXplIGZyb20gXCJwaWNvLW1lbW9pemVcIjtcclxuaW1wb3J0IFdlYlNvY2tldCBmcm9tIFwid3NcIjtcclxuaW1wb3J0IHtFU05leHRPcHRpb25zfSBmcm9tIFwiLi9jb25maWd1cmVcIjtcclxuXHJcbmludGVyZmFjZSBEZXBlbmRlbmN5IHtcclxuICAgIGRlcGVuZGVudHM6IFNldDxzdHJpbmc+O1xyXG4gICAgZGVwZW5kZW5jaWVzOiBTZXQ8c3RyaW5nPjtcclxuICAgIGlzSG1yRW5hYmxlZDogYm9vbGVhbjtcclxuICAgIGlzSG1yQWNjZXB0ZWQ6IGJvb2xlYW47XHJcbiAgICBuZWVkc1JlcGxhY2VtZW50OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRXNtSG1yRW5naW5lIHtcclxuICAgIGNsaWVudHM6IFNldDxXZWJTb2NrZXQ+ID0gbmV3IFNldCgpO1xyXG4gICAgZGVwZW5kZW5jeVRyZWUgPSBuZXcgTWFwPHN0cmluZywgRGVwZW5kZW5jeT4oKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2ZXI6IGh0dHAuU2VydmVyIHwgSHR0cDJTZXJ2ZXIpIHtcclxuICAgICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7bm9TZXJ2ZXI6IHRydWV9KTtcclxuICAgICAgICBzZXJ2ZXIub24oXCJ1cGdyYWRlXCIsIChyZXEsIHNvY2tldCwgaGVhZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVxLmhlYWRlcnNbXCJzZWMtd2Vic29ja2V0LXByb3RvY29sXCJdID09PSBcImVzbS1obXJcIikge1xyXG4gICAgICAgICAgICAgICAgd3NzLmhhbmRsZVVwZ3JhZGUocmVxLCBzb2NrZXQsIGhlYWQsIChjbGllbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB3c3MuZW1pdChcImNvbm5lY3Rpb25cIiwgY2xpZW50LCByZXEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB3c3Mub24oXCJjb25uZWN0aW9uXCIsIChjbGllbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0Q2xpZW50KGNsaWVudCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJMaXN0ZW5lcihjbGllbnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyTGlzdGVuZXIoY2xpZW50OiBXZWJTb2NrZXQpIHtcclxuICAgICAgICBjbGllbnQub24oXCJtZXNzYWdlXCIsIChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09IFwiaG90QWNjZXB0XCIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5nZXRFbnRyeShtZXNzYWdlLmlkLCB0cnVlKSBhcyBEZXBlbmRlbmN5O1xyXG4gICAgICAgICAgICAgICAgZW50cnkuaXNIbXJBY2NlcHRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVFbnRyeShzb3VyY2VVcmw6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IG5ld0VudHJ5OiBEZXBlbmRlbmN5ID0ge1xyXG4gICAgICAgICAgICBkZXBlbmRlbmNpZXM6IG5ldyBTZXQoKSxcclxuICAgICAgICAgICAgZGVwZW5kZW50czogbmV3IFNldCgpLFxyXG4gICAgICAgICAgICBuZWVkc1JlcGxhY2VtZW50OiBmYWxzZSxcclxuICAgICAgICAgICAgaXNIbXJFbmFibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgaXNIbXJBY2NlcHRlZDogZmFsc2VcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyZWUuc2V0KHNvdXJjZVVybCwgbmV3RW50cnkpO1xyXG4gICAgICAgIHJldHVybiBuZXdFbnRyeTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRFbnRyeShzb3VyY2VVcmw6IHN0cmluZywgY3JlYXRlSWZOb3RGb3VuZCA9IGZhbHNlKSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kZXBlbmRlbmN5VHJlZS5nZXQoc291cmNlVXJsKTtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjcmVhdGVJZk5vdEZvdW5kKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUVudHJ5KHNvdXJjZVVybCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEVudHJ5KHNvdXJjZVVybDogc3RyaW5nLCBpbXBvcnRzOiBzdHJpbmdbXSwgaXNIbXJFbmFibGVkID0gZmFsc2UpIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmdldEVudHJ5KHNvdXJjZVVybCwgdHJ1ZSkhO1xyXG4gICAgICAgIGNvbnN0IG91dGRhdGVkRGVwZW5kZW5jaWVzID0gbmV3IFNldChyZXN1bHQuZGVwZW5kZW5jaWVzKTtcclxuICAgICAgICByZXN1bHQuaXNIbXJFbmFibGVkID0gaXNIbXJFbmFibGVkO1xyXG4gICAgICAgIGZvciAoY29uc3QgaW1wb3J0VXJsIG9mIGltcG9ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRSZWxhdGlvbnNoaXAoc291cmNlVXJsLCBpbXBvcnRVcmwpO1xyXG4gICAgICAgICAgICBvdXRkYXRlZERlcGVuZGVuY2llcy5kZWxldGUoaW1wb3J0VXJsKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChjb25zdCBpbXBvcnRVcmwgb2Ygb3V0ZGF0ZWREZXBlbmRlbmNpZXMpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVSZWxhdGlvbnNoaXAoc291cmNlVXJsLCBpbXBvcnRVcmwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVSZWxhdGlvbnNoaXAoc291cmNlVXJsOiBzdHJpbmcsIGltcG9ydFVybDogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IGltcG9ydFJlc3VsdCA9IHRoaXMuZ2V0RW50cnkoaW1wb3J0VXJsKTtcclxuICAgICAgICBpbXBvcnRSZXN1bHQgJiYgaW1wb3J0UmVzdWx0LmRlcGVuZGVudHMuZGVsZXRlKHNvdXJjZVVybCk7XHJcbiAgICAgICAgY29uc3Qgc291cmNlUmVzdWx0ID0gdGhpcy5nZXRFbnRyeShzb3VyY2VVcmwpO1xyXG4gICAgICAgIHNvdXJjZVJlc3VsdCAmJiBzb3VyY2VSZXN1bHQuZGVwZW5kZW5jaWVzLmRlbGV0ZShpbXBvcnRVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZFJlbGF0aW9uc2hpcChzb3VyY2VVcmw6IHN0cmluZywgaW1wb3J0VXJsOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoaW1wb3J0VXJsICE9PSBzb3VyY2VVcmwpIHtcclxuICAgICAgICAgICAgbGV0IGltcG9ydFJlc3VsdCA9IHRoaXMuZ2V0RW50cnkoaW1wb3J0VXJsLCB0cnVlKSE7XHJcbiAgICAgICAgICAgIGltcG9ydFJlc3VsdC5kZXBlbmRlbnRzLmFkZChzb3VyY2VVcmwpO1xyXG4gICAgICAgICAgICBjb25zdCBzb3VyY2VSZXN1bHQgPSB0aGlzLmdldEVudHJ5KHNvdXJjZVVybCwgdHJ1ZSkhO1xyXG4gICAgICAgICAgICBzb3VyY2VSZXN1bHQuZGVwZW5kZW5jaWVzLmFkZChpbXBvcnRVcmwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtYXJrRW50cnlGb3JSZXBsYWNlbWVudChlbnRyeTogRGVwZW5kZW5jeSwgc3RhdGU6IGJvb2xlYW4pIHtcclxuICAgICAgICBlbnRyeS5uZWVkc1JlcGxhY2VtZW50ID0gc3RhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgYnJvYWRjYXN0TWVzc2FnZShkYXRhOiBvYmplY3QpIHtcclxuICAgICAgICB0aGlzLmNsaWVudHMuZm9yRWFjaCgoY2xpZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjbGllbnQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcclxuICAgICAgICAgICAgICAgIGNsaWVudC5zZW5kKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdENsaWVudChjbGllbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdENsaWVudChjbGllbnQ6IFdlYlNvY2tldCkge1xyXG4gICAgICAgIHRoaXMuY2xpZW50cy5hZGQoY2xpZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBkaXNjb25uZWN0Q2xpZW50KGNsaWVudDogV2ViU29ja2V0KSB7XHJcbiAgICAgICAgY2xpZW50LnRlcm1pbmF0ZSgpO1xyXG4gICAgICAgIHRoaXMuY2xpZW50cy5kZWxldGUoY2xpZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBkaXNjb25uZWN0QWxsQ2xpZW50cygpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGNsaWVudCBvZiB0aGlzLmNsaWVudHMpIHtcclxuICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0Q2xpZW50KGNsaWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBIb3RNb2R1bGVSZXBsYWNlbWVudCA9IHtcclxuICAgIGVuZ2luZTogRXNtSG1yRW5naW5lfG51bGxcclxuICAgIGNvbm5lY3Qoc2VydmVyOmh0dHAuU2VydmVyIHwgSHR0cDJTZXJ2ZXIpOnZvaWRcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHVzZUhvdE1vZHVsZVJlcGxhY2VtZW50ID0gbWVtb2l6ZShmdW5jdGlvbiAob3B0aW9uczogRVNOZXh0T3B0aW9ucyk6SG90TW9kdWxlUmVwbGFjZW1lbnQge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBlbmdpbmU6IG51bGwsXHJcbiAgICAgICAgY29ubmVjdChzZXJ2ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5lbmdpbmUgPSBuZXcgRXNtSG1yRW5naW5lKHNlcnZlcik7XHJcbiAgICAgICAgICAgIHNlcnZlci5vbihcImNsb3NlXCIsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW5naW5lIS5kaXNjb25uZWN0QWxsQ2xpZW50cygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pOyJdfQ==