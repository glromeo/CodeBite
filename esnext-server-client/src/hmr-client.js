/**
 * esm-hmr/client.ts
 * A client-side implementation of the ESM-HMR spec, for reference.
 */
function debug(...args) {
    console.log("[ESM-HMR]", ...args);
}
function reload() {
    location.reload(true);
}
let SOCKET_MESSAGE_QUEUE = [];
function _sendSocketMessage(msg) {
    socket.send(JSON.stringify(msg));
}
function sendSocketMessage(msg) {
    if (socket.readyState !== socket.OPEN) {
        SOCKET_MESSAGE_QUEUE.push(msg);
    }
    else {
        _sendSocketMessage(msg);
    }
}
const socketURL = window.HMR_WEBSOCKET_URL ||
    (location.protocol === "http:" ? "ws://" : "wss://") + location.host + "/";
const socket = new WebSocket(socketURL, "esm-hmr");
socket.addEventListener("open", () => {
    SOCKET_MESSAGE_QUEUE.forEach(_sendSocketMessage);
    SOCKET_MESSAGE_QUEUE = [];
});
const REGISTERED_MODULES = {};
class HotModuleState {
    constructor(id) {
        this.data = {};
        this.isLocked = false;
        this.isDeclined = false;
        this.isAccepted = false;
        this.acceptCallbacks = [];
        this.disposeCallbacks = [];
        this.id = id;
    }
    lock() {
        this.isLocked = true;
    }
    dispose(callback) {
        this.disposeCallbacks.push(callback);
    }
    invalidate() {
        reload();
    }
    decline() {
        this.isDeclined = true;
    }
    accept(_deps, callback = true) {
        if (this.isLocked) {
            return;
        }
        if (!this.isAccepted) {
            sendSocketMessage({ id: this.id, type: "hotAccept" });
            this.isAccepted = true;
        }
        if (!Array.isArray(_deps)) {
            callback = _deps || callback;
            _deps = [];
        }
        if (callback === true) {
            callback = () => { };
        }
        const deps = _deps.map((dep) => {
            const ext = dep.split(".").pop();
            if (!ext) {
                dep += ".js";
            }
            else if (ext !== "js") {
                dep += ".proxy.js";
            }
            return new URL(dep, `${window.location.origin}${this.id}`).pathname;
        });
        this.acceptCallbacks.push({
            deps,
            callback,
        });
    }
}
export function createHotContext(fullUrl) {
    const id = new URL(fullUrl).pathname;
    const existing = REGISTERED_MODULES[id];
    if (existing) {
        existing.lock();
        return existing;
    }
    const state = new HotModuleState(id);
    REGISTERED_MODULES[id] = state;
    return state;
}
async function applyUpdate(id) {
    const state = REGISTERED_MODULES[id];
    if (!state) {
        return false;
    }
    if (state.isDeclined) {
        return false;
    }
    const acceptCallbacks = state.acceptCallbacks;
    const disposeCallbacks = state.disposeCallbacks;
    state.disposeCallbacks = [];
    state.data = {};
    disposeCallbacks.map((callback) => callback());
    const updateID = Date.now();
    for (const { deps, callback: acceptCallback } of acceptCallbacks) {
        const [module, ...depModules] = await Promise.all([
            import(id + `?mtime=${updateID}`),
            ...deps.map((d) => import(d + `?mtime=${updateID}`)),
        ]);
        acceptCallback({ module, deps: depModules });
    }
    return true;
}
socket.addEventListener("message", ({ data: _data }) => {
    if (!_data) {
        return;
    }
    const data = JSON.parse(_data);
    debug("message", data);
    if (data.type === "reload") {
        debug("message: reload");
        reload();
        return;
    }
    if (data.type !== "update") {
        debug("message: unknown", data);
        return;
    }
    debug("message: update", data);
    debug(data.url, Object.keys(REGISTERED_MODULES));
    applyUpdate(data.url)
        .then((ok) => {
        if (!ok) {
            reload();
        }
    })
        .catch((err) => {
        console.error(err);
        reload();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhtci1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBU0gsU0FBUyxLQUFLLENBQUMsR0FBRyxJQUFXO0lBQ3pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQUNELFNBQVMsTUFBTTtJQUNYLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQUVELElBQUksb0JBQW9CLEdBQVUsRUFBRSxDQUFDO0FBQ3JDLFNBQVMsa0JBQWtCLENBQUMsR0FBUTtJQUNoQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyQyxDQUFDO0FBQ0QsU0FBUyxpQkFBaUIsQ0FBQyxHQUFRO0lBQy9CLElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25DLG9CQUFvQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsQztTQUFNO1FBQ0gsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDM0I7QUFDTCxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQ1YsTUFBYyxDQUFDLGlCQUFpQjtJQUNqQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQy9FLE1BQU0sTUFBTSxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNuRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtJQUNqQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FB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QUFTLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO0lBQ25ELElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDUixPQUFPO0tBQ1Y7SUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkIsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUN4QixLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN6QixNQUFNLEVBQUUsQ0FBQztRQUNULE9BQU87S0FDVjtJQUNELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7UUFDeEIsS0FBSyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU87S0FDVjtJQUNELEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUNqRCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztTQUNoQixJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtRQUNULElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDTCxNQUFNLEVBQUUsQ0FBQztTQUNaO0lBQ0wsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDWCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBlc20taG1yL2NsaWVudC50c1xyXG4gKiBBIGNsaWVudC1zaWRlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBFU00tSE1SIHNwZWMsIGZvciByZWZlcmVuY2UuXHJcbiAqL1xyXG5cclxudHlwZSBEaXNwb3NlQ2FsbGJhY2sgPSAoKSA9PiB2b2lkO1xyXG50eXBlIEFjY2VwdENhbGxiYWNrID0gKGFyZ3M6IHsgbW9kdWxlOiBhbnk7IGRlcHM6IGFueVtdIH0pID0+IHZvaWQ7XHJcbnR5cGUgQWNjZXB0Q2FsbGJhY2tPYmplY3QgPSB7XHJcbiAgICBkZXBzOiBzdHJpbmdbXTtcclxuICAgIGNhbGxiYWNrOiBBY2NlcHRDYWxsYmFjaztcclxufTtcclxuXHJcbmZ1bmN0aW9uIGRlYnVnKC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcIltFU00tSE1SXVwiLCAuLi5hcmdzKTtcclxufVxyXG5mdW5jdGlvbiByZWxvYWQoKSB7XHJcbiAgICBsb2NhdGlvbi5yZWxvYWQodHJ1ZSk7XHJcbn1cclxuXHJcbmxldCBTT0NLRVRfTUVTU0FHRV9RVUVVRTogYW55W10gPSBbXTtcclxuZnVuY3Rpb24gX3NlbmRTb2NrZXRNZXNzYWdlKG1zZzogYW55KSB7XHJcbiAgICBzb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShtc2cpKTtcclxufVxyXG5mdW5jdGlvbiBzZW5kU29ja2V0TWVzc2FnZShtc2c6IGFueSkge1xyXG4gICAgaWYgKHNvY2tldC5yZWFkeVN0YXRlICE9PSBzb2NrZXQuT1BFTikge1xyXG4gICAgICAgIFNPQ0tFVF9NRVNTQUdFX1FVRVVFLnB1c2gobXNnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgX3NlbmRTb2NrZXRNZXNzYWdlKG1zZyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IHNvY2tldFVSTCA9XHJcbiAgICAod2luZG93IGFzIGFueSkuSE1SX1dFQlNPQ0tFVF9VUkwgfHxcclxuICAgIChsb2NhdGlvbi5wcm90b2NvbCA9PT0gXCJodHRwOlwiID8gXCJ3czovL1wiIDogXCJ3c3M6Ly9cIikgKyBsb2NhdGlvbi5ob3N0ICsgXCIvXCI7XHJcbmNvbnN0IHNvY2tldCA9IG5ldyBXZWJTb2NrZXQoc29ja2V0VVJMLCBcImVzbS1obXJcIik7XHJcbnNvY2tldC5hZGRFdmVudExpc3RlbmVyKFwib3BlblwiLCAoKSA9PiB7XHJcbiAgICBTT0NLRVRfTUVTU0FHRV9RVUVVRS5mb3JFYWNoKF9zZW5kU29ja2V0TWVzc2FnZSk7XHJcbiAgICBTT0NLRVRfTUVTU0FHRV9RVUVVRSA9IFtdO1xyXG59KTtcclxuXHJcbmNvbnN0IFJFR0lTVEVSRURfTU9EVUxFUzogeyBba2V5OiBzdHJpbmddOiBIb3RNb2R1bGVTdGF0ZSB9ID0ge307XHJcblxyXG5jbGFzcyBIb3RNb2R1bGVTdGF0ZSB7XHJcbiAgICBpZDogc3RyaW5nO1xyXG4gICAgZGF0YTogYW55ID0ge307XHJcbiAgICBpc0xvY2tlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgaXNEZWNsaW5lZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgaXNBY2NlcHRlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgYWNjZXB0Q2FsbGJhY2tzOiBBY2NlcHRDYWxsYmFja09iamVjdFtdID0gW107XHJcbiAgICBkaXNwb3NlQ2FsbGJhY2tzOiBEaXNwb3NlQ2FsbGJhY2tbXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmlkID0gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgbG9jaygpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmlzTG9ja2VkID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBkaXNwb3NlKGNhbGxiYWNrOiBEaXNwb3NlQ2FsbGJhY2spOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2VDYWxsYmFja3MucHVzaChjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgaW52YWxpZGF0ZSgpOiB2b2lkIHtcclxuICAgICAgICByZWxvYWQoKTtcclxuICAgIH1cclxuXHJcbiAgICBkZWNsaW5lKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaXNEZWNsaW5lZCA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgYWNjZXB0KF9kZXBzOiBzdHJpbmdbXSwgY2FsbGJhY2s6IHRydWUgfCBBY2NlcHRDYWxsYmFjayA9IHRydWUpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5pc0xvY2tlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5pc0FjY2VwdGVkKSB7XHJcbiAgICAgICAgICAgIHNlbmRTb2NrZXRNZXNzYWdlKHsgaWQ6IHRoaXMuaWQsIHR5cGU6IFwiaG90QWNjZXB0XCIgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaXNBY2NlcHRlZCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShfZGVwcykpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sgPSBfZGVwcyB8fCBjYWxsYmFjaztcclxuICAgICAgICAgICAgX2RlcHMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNhbGxiYWNrID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrID0gKCkgPT4ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRlcHMgPSBfZGVwcy5tYXAoKGRlcCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBleHQgPSBkZXAuc3BsaXQoXCIuXCIpLnBvcCgpO1xyXG4gICAgICAgICAgICBpZiAoIWV4dCkge1xyXG4gICAgICAgICAgICAgICAgZGVwICs9IFwiLmpzXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXh0ICE9PSBcImpzXCIpIHtcclxuICAgICAgICAgICAgICAgIGRlcCArPSBcIi5wcm94eS5qc1wiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgVVJMKGRlcCwgYCR7d2luZG93LmxvY2F0aW9uLm9yaWdpbn0ke3RoaXMuaWR9YCkucGF0aG5hbWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5hY2NlcHRDYWxsYmFja3MucHVzaCh7XHJcbiAgICAgICAgICAgIGRlcHMsXHJcbiAgICAgICAgICAgIGNhbGxiYWNrLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlSG90Q29udGV4dChmdWxsVXJsOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGlkID0gbmV3IFVSTChmdWxsVXJsKS5wYXRobmFtZTtcclxuICAgIGNvbnN0IGV4aXN0aW5nID0gUkVHSVNURVJFRF9NT0RVTEVTW2lkXTtcclxuICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICAgIGV4aXN0aW5nLmxvY2soKTtcclxuICAgICAgICByZXR1cm4gZXhpc3Rpbmc7XHJcbiAgICB9XHJcbiAgICBjb25zdCBzdGF0ZSA9IG5ldyBIb3RNb2R1bGVTdGF0ZShpZCk7XHJcbiAgICBSRUdJU1RFUkVEX01PRFVMRVNbaWRdID0gc3RhdGU7XHJcbiAgICByZXR1cm4gc3RhdGU7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGFwcGx5VXBkYXRlKGlkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHN0YXRlID0gUkVHSVNURVJFRF9NT0RVTEVTW2lkXTtcclxuICAgIGlmICghc3RhdGUpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBpZiAoc3RhdGUuaXNEZWNsaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhY2NlcHRDYWxsYmFja3MgPSBzdGF0ZS5hY2NlcHRDYWxsYmFja3M7XHJcbiAgICBjb25zdCBkaXNwb3NlQ2FsbGJhY2tzID0gc3RhdGUuZGlzcG9zZUNhbGxiYWNrcztcclxuICAgIHN0YXRlLmRpc3Bvc2VDYWxsYmFja3MgPSBbXTtcclxuICAgIHN0YXRlLmRhdGEgPSB7fTtcclxuXHJcbiAgICBkaXNwb3NlQ2FsbGJhY2tzLm1hcCgoY2FsbGJhY2spID0+IGNhbGxiYWNrKCkpO1xyXG4gICAgY29uc3QgdXBkYXRlSUQgPSBEYXRlLm5vdygpO1xyXG4gICAgZm9yIChjb25zdCB7IGRlcHMsIGNhbGxiYWNrOiBhY2NlcHRDYWxsYmFjayB9IG9mIGFjY2VwdENhbGxiYWNrcykge1xyXG4gICAgICAgIGNvbnN0IFttb2R1bGUsIC4uLmRlcE1vZHVsZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xyXG4gICAgICAgICAgICBpbXBvcnQoaWQgKyBgP210aW1lPSR7dXBkYXRlSUR9YCksXHJcbiAgICAgICAgICAgIC4uLmRlcHMubWFwKChkKSA9PiBpbXBvcnQoZCArIGA/bXRpbWU9JHt1cGRhdGVJRH1gKSksXHJcbiAgICAgICAgXSk7XHJcbiAgICAgICAgYWNjZXB0Q2FsbGJhY2soeyBtb2R1bGUsIGRlcHM6IGRlcE1vZHVsZXMgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbnNvY2tldC5hZGRFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCAoeyBkYXRhOiBfZGF0YSB9KSA9PiB7XHJcbiAgICBpZiAoIV9kYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoX2RhdGEpO1xyXG4gICAgZGVidWcoXCJtZXNzYWdlXCIsIGRhdGEpO1xyXG4gICAgaWYgKGRhdGEudHlwZSA9PT0gXCJyZWxvYWRcIikge1xyXG4gICAgICAgIGRlYnVnKFwibWVzc2FnZTogcmVsb2FkXCIpO1xyXG4gICAgICAgIHJlbG9hZCgpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChkYXRhLnR5cGUgIT09IFwidXBkYXRlXCIpIHtcclxuICAgICAgICBkZWJ1ZyhcIm1lc3NhZ2U6IHVua25vd25cIiwgZGF0YSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZGVidWcoXCJtZXNzYWdlOiB1cGRhdGVcIiwgZGF0YSk7XHJcbiAgICBkZWJ1ZyhkYXRhLnVybCwgT2JqZWN0LmtleXMoUkVHSVNURVJFRF9NT0RVTEVTKSk7XHJcbiAgICBhcHBseVVwZGF0ZShkYXRhLnVybClcclxuICAgICAgICAudGhlbigob2spID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvaykge1xyXG4gICAgICAgICAgICAgICAgcmVsb2FkKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgcmVsb2FkKCk7XHJcbiAgICAgICAgfSk7XHJcbn0pO1xyXG4iXX0=