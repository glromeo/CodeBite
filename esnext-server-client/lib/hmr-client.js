/**
 * esm-hmr/client.ts
 * A client-side implementation of the ESM-HMR spec, for reference.
 */
function debug(...args) {
    console.log("[ESM-HMR]", ...args);
}
function reload() {
    location.reload();
}
let SOCKET_MESSAGE_QUEUE = [];
function _sendSocketMessage(msg) {
    socket.send(JSON.stringify(msg));
}
function sendSocketMessage(msg) {
    if (socket.readyState !== socket.OPEN) {
        SOCKET_MESSAGE_QUEUE.push(msg);
    }
    else {
        _sendSocketMessage(msg);
    }
}
const socketURL = window.HMR_WEBSOCKET_URL ||
    (location.protocol === "http:" ? "ws://" : "wss://") + location.host + "/";
const socket = new WebSocket(socketURL, "esm-hmr");
socket.addEventListener("open", () => {
    SOCKET_MESSAGE_QUEUE.forEach(_sendSocketMessage);
    SOCKET_MESSAGE_QUEUE = [];
});
const REGISTERED_MODULES = {};
class HotModuleState {
    constructor(id) {
        this.data = {};
        this.isLocked = false;
        this.isDeclined = false;
        this.isAccepted = false;
        this.acceptCallbacks = [];
        this.disposeCallbacks = [];
        this.id = id;
    }
    lock() {
        this.isLocked = true;
    }
    dispose(callback) {
        this.disposeCallbacks.push(callback);
    }
    invalidate() {
        reload();
    }
    decline() {
        this.isDeclined = true;
    }
    accept(_deps, callback = true) {
        if (this.isLocked) {
            return;
        }
        if (!this.isAccepted) {
            sendSocketMessage({ id: this.id, type: "hotAccept" });
            this.isAccepted = true;
        }
        if (!Array.isArray(_deps)) {
            callback = _deps || callback;
            _deps = [];
        }
        if (callback === true) {
            callback = () => { };
        }
        const deps = _deps.map((dep) => {
            const ext = dep.split(".").pop();
            if (!ext) {
                dep += ".js";
            }
            else if (ext !== "js") {
                dep += ".proxy.js";
            }
            return new URL(dep, `${window.location.origin}${this.id}`).pathname;
        });
        this.acceptCallbacks.push({
            deps,
            callback,
        });
    }
}
export function createHotContext(fullUrl) {
    const id = new URL(fullUrl).pathname;
    const existing = REGISTERED_MODULES[id];
    if (existing) {
        existing.lock();
        return existing;
    }
    const state = new HotModuleState(id);
    REGISTERED_MODULES[id] = state;
    return state;
}
async function applyUpdate(id) {
    const state = REGISTERED_MODULES[id];
    if (!state) {
        return false;
    }
    if (state.isDeclined) {
        return false;
    }
    const acceptCallbacks = state.acceptCallbacks;
    const disposeCallbacks = state.disposeCallbacks;
    state.disposeCallbacks = [];
    state.data = {};
    disposeCallbacks.map((callback) => callback());
    const updateID = Date.now();
    for (const { deps, callback: acceptCallback } of acceptCallbacks) {
        const [module, ...depModules] = await Promise.all([
            import(id + `?mtime=${updateID}`),
            ...deps.map((d) => import(d + `?mtime=${updateID}`)),
        ]);
        acceptCallback({ module, deps: depModules });
    }
    return true;
}
socket.addEventListener("message", ({ data: _data }) => {
    if (!_data) {
        return;
    }
    const data = JSON.parse(_data);
    debug("message", data);
    if (data.type === "reload") {
        debug("message: reload");
        reload();
        return;
    }
    if (data.type !== "update") {
        debug("message: unknown", data);
        return;
    }
    debug("message: update", data);
    debug(data.url, Object.keys(REGISTERED_MODULES));
    applyUpdate(data.url)
        .then((ok) => {
        if (!ok) {
            reload();
        }
    })
        .catch((err) => {
        console.error(err);
        reload();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9obXItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQVNILFNBQVMsS0FBSyxDQUFDLEdBQUcsSUFBVztJQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFDRCxTQUFTLE1BQU07SUFDWCxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDdEIsQ0FBQztBQUVELElBQUksb0JBQW9CLEdBQVUsRUFBRSxDQUFDO0FBQ3JDLFNBQVMsa0JBQWtCLENBQUMsR0FBUTtJQUNoQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyQyxDQUFDO0FBQ0QsU0FBUyxpQkFBaUIsQ0FBQyxHQUFRO0lBQy9CLElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25DLG9CQUFvQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsQztTQUFNO1FBQ0gsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDM0I7QUFDTCxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQ1YsTUFBYyxDQUFDLGlCQUFpQjtJQUNqQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQy9FLE1BQU0sTUFBTSxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNuRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtJQUNqQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJ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LEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO0lBQ25ELElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDUixPQUFPO0tBQ1Y7SUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkIsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUN4QixLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN6QixNQUFNLEVBQUUsQ0FBQztRQUNULE9BQU87S0FDVjtJQUNELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7UUFDeEIsS0FBSyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU87S0FDVjtJQUNELEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUNqRCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztTQUNoQixJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtRQUNULElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDTCxNQUFNLEVBQUUsQ0FBQztTQUNaO0lBQ0wsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDWCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBlc20taG1yL2NsaWVudC50c1xyXG4gKiBBIGNsaWVudC1zaWRlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBFU00tSE1SIHNwZWMsIGZvciByZWZlcmVuY2UuXHJcbiAqL1xyXG5cclxudHlwZSBEaXNwb3NlQ2FsbGJhY2sgPSAoKSA9PiB2b2lkO1xyXG50eXBlIEFjY2VwdENhbGxiYWNrID0gKGFyZ3M6IHsgbW9kdWxlOiBhbnk7IGRlcHM6IGFueVtdIH0pID0+IHZvaWQ7XHJcbnR5cGUgQWNjZXB0Q2FsbGJhY2tPYmplY3QgPSB7XHJcbiAgICBkZXBzOiBzdHJpbmdbXTtcclxuICAgIGNhbGxiYWNrOiBBY2NlcHRDYWxsYmFjaztcclxufTtcclxuXHJcbmZ1bmN0aW9uIGRlYnVnKC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcIltFU00tSE1SXVwiLCAuLi5hcmdzKTtcclxufVxyXG5mdW5jdGlvbiByZWxvYWQoKSB7XHJcbiAgICBsb2NhdGlvbi5yZWxvYWQoKTtcclxufVxyXG5cclxubGV0IFNPQ0tFVF9NRVNTQUdFX1FVRVVFOiBhbnlbXSA9IFtdO1xyXG5mdW5jdGlvbiBfc2VuZFNvY2tldE1lc3NhZ2UobXNnOiBhbnkpIHtcclxuICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KG1zZykpO1xyXG59XHJcbmZ1bmN0aW9uIHNlbmRTb2NrZXRNZXNzYWdlKG1zZzogYW55KSB7XHJcbiAgICBpZiAoc29ja2V0LnJlYWR5U3RhdGUgIT09IHNvY2tldC5PUEVOKSB7XHJcbiAgICAgICAgU09DS0VUX01FU1NBR0VfUVVFVUUucHVzaChtc2cpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBfc2VuZFNvY2tldE1lc3NhZ2UobXNnKTtcclxuICAgIH1cclxufVxyXG5cclxuY29uc3Qgc29ja2V0VVJMID1cclxuICAgICh3aW5kb3cgYXMgYW55KS5ITVJfV0VCU09DS0VUX1VSTCB8fFxyXG4gICAgKGxvY2F0aW9uLnByb3RvY29sID09PSBcImh0dHA6XCIgPyBcIndzOi8vXCIgOiBcIndzczovL1wiKSArIGxvY2F0aW9uLmhvc3QgKyBcIi9cIjtcclxuY29uc3Qgc29ja2V0ID0gbmV3IFdlYlNvY2tldChzb2NrZXRVUkwsIFwiZXNtLWhtclwiKTtcclxuc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJvcGVuXCIsICgpID0+IHtcclxuICAgIFNPQ0tFVF9NRVNTQUdFX1FVRVVFLmZvckVhY2goX3NlbmRTb2NrZXRNZXNzYWdlKTtcclxuICAgIFNPQ0tFVF9NRVNTQUdFX1FVRVVFID0gW107XHJcbn0pO1xyXG5cclxuY29uc3QgUkVHSVNURVJFRF9NT0RVTEVTOiB7IFtrZXk6IHN0cmluZ106IEhvdE1vZHVsZVN0YXRlIH0gPSB7fTtcclxuXHJcbmNsYXNzIEhvdE1vZHVsZVN0YXRlIHtcclxuICAgIGlkOiBzdHJpbmc7XHJcbiAgICBkYXRhOiBhbnkgPSB7fTtcclxuICAgIGlzTG9ja2VkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBpc0RlY2xpbmVkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBpc0FjY2VwdGVkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBhY2NlcHRDYWxsYmFja3M6IEFjY2VwdENhbGxiYWNrT2JqZWN0W10gPSBbXTtcclxuICAgIGRpc3Bvc2VDYWxsYmFja3M6IERpc3Bvc2VDYWxsYmFja1tdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIH1cclxuXHJcbiAgICBsb2NrKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaXNMb2NrZWQgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc3Bvc2UoY2FsbGJhY2s6IERpc3Bvc2VDYWxsYmFjayk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTtcclxuICAgIH1cclxuXHJcbiAgICBpbnZhbGlkYXRlKCk6IHZvaWQge1xyXG4gICAgICAgIHJlbG9hZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGRlY2xpbmUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5pc0RlY2xpbmVkID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBhY2NlcHQoX2RlcHM6IHN0cmluZ1tdLCBjYWxsYmFjazogdHJ1ZSB8IEFjY2VwdENhbGxiYWNrID0gdHJ1ZSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmlzTG9ja2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzQWNjZXB0ZWQpIHtcclxuICAgICAgICAgICAgc2VuZFNvY2tldE1lc3NhZ2UoeyBpZDogdGhpcy5pZCwgdHlwZTogXCJob3RBY2NlcHRcIiB9KTtcclxuICAgICAgICAgICAgdGhpcy5pc0FjY2VwdGVkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KF9kZXBzKSkge1xyXG4gICAgICAgICAgICBjYWxsYmFjayA9IF9kZXBzIHx8IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICBfZGVwcyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sgPSAoKSA9PiB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGVwcyA9IF9kZXBzLm1hcCgoZGVwKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4dCA9IGRlcC5zcGxpdChcIi5cIikucG9wKCk7XHJcbiAgICAgICAgICAgIGlmICghZXh0KSB7XHJcbiAgICAgICAgICAgICAgICBkZXAgKz0gXCIuanNcIjtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChleHQgIT09IFwianNcIikge1xyXG4gICAgICAgICAgICAgICAgZGVwICs9IFwiLnByb3h5LmpzXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkwoZGVwLCBgJHt3aW5kb3cubG9jYXRpb24ub3JpZ2lufSR7dGhpcy5pZH1gKS5wYXRobmFtZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmFjY2VwdENhbGxiYWNrcy5wdXNoKHtcclxuICAgICAgICAgICAgZGVwcyxcclxuICAgICAgICAgICAgY2FsbGJhY2ssXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVIb3RDb250ZXh0KGZ1bGxVcmw6IHN0cmluZykge1xyXG4gICAgY29uc3QgaWQgPSBuZXcgVVJMKGZ1bGxVcmwpLnBhdGhuYW1lO1xyXG4gICAgY29uc3QgZXhpc3RpbmcgPSBSRUdJU1RFUkVEX01PRFVMRVNbaWRdO1xyXG4gICAgaWYgKGV4aXN0aW5nKSB7XHJcbiAgICAgICAgZXhpc3RpbmcubG9jaygpO1xyXG4gICAgICAgIHJldHVybiBleGlzdGluZztcclxuICAgIH1cclxuICAgIGNvbnN0IHN0YXRlID0gbmV3IEhvdE1vZHVsZVN0YXRlKGlkKTtcclxuICAgIFJFR0lTVEVSRURfTU9EVUxFU1tpZF0gPSBzdGF0ZTtcclxuICAgIHJldHVybiBzdGF0ZTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gYXBwbHlVcGRhdGUoaWQ6IHN0cmluZykge1xyXG4gICAgY29uc3Qgc3RhdGUgPSBSRUdJU1RFUkVEX01PRFVMRVNbaWRdO1xyXG4gICAgaWYgKCFzdGF0ZSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChzdGF0ZS5pc0RlY2xpbmVkKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFjY2VwdENhbGxiYWNrcyA9IHN0YXRlLmFjY2VwdENhbGxiYWNrcztcclxuICAgIGNvbnN0IGRpc3Bvc2VDYWxsYmFja3MgPSBzdGF0ZS5kaXNwb3NlQ2FsbGJhY2tzO1xyXG4gICAgc3RhdGUuZGlzcG9zZUNhbGxiYWNrcyA9IFtdO1xyXG4gICAgc3RhdGUuZGF0YSA9IHt9O1xyXG5cclxuICAgIGRpc3Bvc2VDYWxsYmFja3MubWFwKChjYWxsYmFjaykgPT4gY2FsbGJhY2soKSk7XHJcbiAgICBjb25zdCB1cGRhdGVJRCA9IERhdGUubm93KCk7XHJcbiAgICBmb3IgKGNvbnN0IHsgZGVwcywgY2FsbGJhY2s6IGFjY2VwdENhbGxiYWNrIH0gb2YgYWNjZXB0Q2FsbGJhY2tzKSB7XHJcbiAgICAgICAgY29uc3QgW21vZHVsZSwgLi4uZGVwTW9kdWxlc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICAgICAgICAgIGltcG9ydChpZCArIGA/bXRpbWU9JHt1cGRhdGVJRH1gKSxcclxuICAgICAgICAgICAgLi4uZGVwcy5tYXAoKGQpID0+IGltcG9ydChkICsgYD9tdGltZT0ke3VwZGF0ZUlEfWApKSxcclxuICAgICAgICBdKTtcclxuICAgICAgICBhY2NlcHRDYWxsYmFjayh7IG1vZHVsZSwgZGVwczogZGVwTW9kdWxlcyB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsICh7IGRhdGE6IF9kYXRhIH0pID0+IHtcclxuICAgIGlmICghX2RhdGEpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShfZGF0YSk7XHJcbiAgICBkZWJ1ZyhcIm1lc3NhZ2VcIiwgZGF0YSk7XHJcbiAgICBpZiAoZGF0YS50eXBlID09PSBcInJlbG9hZFwiKSB7XHJcbiAgICAgICAgZGVidWcoXCJtZXNzYWdlOiByZWxvYWRcIik7XHJcbiAgICAgICAgcmVsb2FkKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGRhdGEudHlwZSAhPT0gXCJ1cGRhdGVcIikge1xyXG4gICAgICAgIGRlYnVnKFwibWVzc2FnZTogdW5rbm93blwiLCBkYXRhKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBkZWJ1ZyhcIm1lc3NhZ2U6IHVwZGF0ZVwiLCBkYXRhKTtcclxuICAgIGRlYnVnKGRhdGEudXJsLCBPYmplY3Qua2V5cyhSRUdJU1RFUkVEX01PRFVMRVMpKTtcclxuICAgIGFwcGx5VXBkYXRlKGRhdGEudXJsKVxyXG4gICAgICAgIC50aGVuKChvaykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIW9rKSB7XHJcbiAgICAgICAgICAgICAgICByZWxvYWQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICByZWxvYWQoKTtcclxuICAgICAgICB9KTtcclxufSk7XHJcbiJdfQ==