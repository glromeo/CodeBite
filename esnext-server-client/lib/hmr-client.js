/**
 * esm-hmr/client.ts
 * A client-side implementation of the ESM-HMR spec, for reference.
 */
function debug(...args) {
    console.log("[ESM-HMR]", ...args);
}
function reload() {
    location.reload();
}
let SOCKET_MESSAGE_QUEUE = [];
function _sendSocketMessage(msg) {
    socket.send(JSON.stringify(msg));
}
function sendSocketMessage(msg) {
    if (socket.readyState !== socket.OPEN) {
        SOCKET_MESSAGE_QUEUE.push(msg);
    }
    else {
        _sendSocketMessage(msg);
    }
}
const socketURL = window.HMR_WEBSOCKET_URL ||
    (location.protocol === "http:" ? "ws://" : "wss://") + location.host + "/";
const socket = new WebSocket(socketURL, "esm-hmr");
socket.addEventListener("open", () => {
    SOCKET_MESSAGE_QUEUE.forEach(_sendSocketMessage);
    SOCKET_MESSAGE_QUEUE = [];
});
const REGISTERED_MODULES = {};
class HotModuleState {
    constructor(id) {
        this.data = {};
        this.isLocked = false;
        this.isDeclined = false;
        this.isAccepted = false;
        this.acceptCallbacks = [];
        this.disposeCallbacks = [];
        this.id = id;
    }
    lock() {
        this.isLocked = true;
    }
    dispose(callback) {
        this.disposeCallbacks.push(callback);
    }
    invalidate() {
        reload();
    }
    decline() {
        this.isDeclined = true;
    }
    accept(_deps, callback = true) {
        if (this.isLocked) {
            return;
        }
        if (!this.isAccepted) {
            sendSocketMessage({ id: this.id, type: "hotAccept" });
            this.isAccepted = true;
        }
        if (!Array.isArray(_deps)) {
            callback = _deps || callback;
            _deps = [];
        }
        if (callback === true) {
            callback = () => { };
        }
        const deps = _deps.map((dep) => {
            const ext = dep.split(".").pop();
            if (!ext) {
                dep += ".js";
            }
            else if (ext !== "js") {
                dep += ".proxy.js";
            }
            return new URL(dep, `${window.location.origin}${this.id}`).pathname;
        });
        this.acceptCallbacks.push({
            deps,
            callback,
        });
    }
}
export function createHotContext(fullUrl) {
    const id = new URL(fullUrl).pathname;
    const existing = REGISTERED_MODULES[id];
    if (existing) {
        existing.lock();
        return existing;
    }
    const state = new HotModuleState(id);
    REGISTERED_MODULES[id] = state;
    return state;
}
async function applyUpdate(id) {
    const state = REGISTERED_MODULES[id];
    if (!state) {
        return false;
    }
    if (state.isDeclined) {
        return false;
    }
    const acceptCallbacks = state.acceptCallbacks;
    const disposeCallbacks = state.disposeCallbacks;
    state.disposeCallbacks = [];
    state.data = {};
    disposeCallbacks.map((callback) => callback());
    const updateID = Date.now();
    for (const { deps, callback: acceptCallback } of acceptCallbacks) {
        const [module, ...depModules] = await Promise.all([
            import(id + `?mtime=${updateID}`),
            ...deps.map((d) => import(d + `?mtime=${updateID}`)),
        ]);
        acceptCallback({ module, deps: depModules });
    }
    return true;
}
socket.addEventListener("message", ({ data: _data }) => {
    if (!_data) {
        return;
    }
    const data = JSON.parse(_data);
    debug("message", data);
    if (data.type === "reload") {
        debug("message: reload");
        reload();
        return;
    }
    if (data.type !== "update") {
        debug("message: unknown", data);
        return;
    }
    debug("message: update", data);
    debug(data.url, Object.keys(REGISTERED_MODULES));
    applyUpdate(data.url)
        .then((ok) => {
        if (!ok) {
            reload();
        }
    })
        .catch((err) => {
        console.error(err);
        reload();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9obXItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQVNILFNBQVMsS0FBSyxDQUFDLEdBQUcsSUFBVztJQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFDRCxTQUFTLE1BQU07SUFDWCxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDdEIsQ0FBQztBQUVELElBQUksb0JBQW9CLEdBQVUsRUFBRSxDQUFDO0FBQ3JDLFNBQVMsa0JBQWtCLENBQUMsR0FBUTtJQUNoQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyQyxDQUFDO0FBQ0QsU0FBUyxpQkFBaUIsQ0FBQyxHQUFRO0lBQy9CLElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25DLG9CQUFvQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsQztTQUFNO1FBQ0gsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDM0I7QUFDTCxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQ1YsTUFBYyxDQUFDLGlCQUFpQjtJQUNqQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQy9FLE1BQU0sTUFBTSxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNuRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtJQUNqQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJ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LEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO0lBQ25ELElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDUixPQUFPO0tBQ1Y7SUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkIsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUN4QixLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN6QixNQUFNLEVBQUUsQ0FBQztRQUNULE9BQU87S0FDVjtJQUNELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7UUFDeEIsS0FBSyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU87S0FDVjtJQUNELEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUNqRCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztTQUNoQixJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtRQUNULElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDTCxNQUFNLEVBQUUsQ0FBQztTQUNaO0lBQ0wsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDWCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogZXNtLWhtci9jbGllbnQudHNcbiAqIEEgY2xpZW50LXNpZGUgaW1wbGVtZW50YXRpb24gb2YgdGhlIEVTTS1ITVIgc3BlYywgZm9yIHJlZmVyZW5jZS5cbiAqL1xuXG50eXBlIERpc3Bvc2VDYWxsYmFjayA9ICgpID0+IHZvaWQ7XG50eXBlIEFjY2VwdENhbGxiYWNrID0gKGFyZ3M6IHsgbW9kdWxlOiBhbnk7IGRlcHM6IGFueVtdIH0pID0+IHZvaWQ7XG50eXBlIEFjY2VwdENhbGxiYWNrT2JqZWN0ID0ge1xuICAgIGRlcHM6IHN0cmluZ1tdO1xuICAgIGNhbGxiYWNrOiBBY2NlcHRDYWxsYmFjaztcbn07XG5cbmZ1bmN0aW9uIGRlYnVnKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgY29uc29sZS5sb2coXCJbRVNNLUhNUl1cIiwgLi4uYXJncyk7XG59XG5mdW5jdGlvbiByZWxvYWQoKSB7XG4gICAgbG9jYXRpb24ucmVsb2FkKCk7XG59XG5cbmxldCBTT0NLRVRfTUVTU0FHRV9RVUVVRTogYW55W10gPSBbXTtcbmZ1bmN0aW9uIF9zZW5kU29ja2V0TWVzc2FnZShtc2c6IGFueSkge1xuICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KG1zZykpO1xufVxuZnVuY3Rpb24gc2VuZFNvY2tldE1lc3NhZ2UobXNnOiBhbnkpIHtcbiAgICBpZiAoc29ja2V0LnJlYWR5U3RhdGUgIT09IHNvY2tldC5PUEVOKSB7XG4gICAgICAgIFNPQ0tFVF9NRVNTQUdFX1FVRVVFLnB1c2gobXNnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBfc2VuZFNvY2tldE1lc3NhZ2UobXNnKTtcbiAgICB9XG59XG5cbmNvbnN0IHNvY2tldFVSTCA9XG4gICAgKHdpbmRvdyBhcyBhbnkpLkhNUl9XRUJTT0NLRVRfVVJMIHx8XG4gICAgKGxvY2F0aW9uLnByb3RvY29sID09PSBcImh0dHA6XCIgPyBcIndzOi8vXCIgOiBcIndzczovL1wiKSArIGxvY2F0aW9uLmhvc3QgKyBcIi9cIjtcbmNvbnN0IHNvY2tldCA9IG5ldyBXZWJTb2NrZXQoc29ja2V0VVJMLCBcImVzbS1obXJcIik7XG5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcihcIm9wZW5cIiwgKCkgPT4ge1xuICAgIFNPQ0tFVF9NRVNTQUdFX1FVRVVFLmZvckVhY2goX3NlbmRTb2NrZXRNZXNzYWdlKTtcbiAgICBTT0NLRVRfTUVTU0FHRV9RVUVVRSA9IFtdO1xufSk7XG5cbmNvbnN0IFJFR0lTVEVSRURfTU9EVUxFUzogeyBba2V5OiBzdHJpbmddOiBIb3RNb2R1bGVTdGF0ZSB9ID0ge307XG5cbmNsYXNzIEhvdE1vZHVsZVN0YXRlIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIGRhdGE6IGFueSA9IHt9O1xuICAgIGlzTG9ja2VkOiBib29sZWFuID0gZmFsc2U7XG4gICAgaXNEZWNsaW5lZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIGlzQWNjZXB0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBhY2NlcHRDYWxsYmFja3M6IEFjY2VwdENhbGxiYWNrT2JqZWN0W10gPSBbXTtcbiAgICBkaXNwb3NlQ2FsbGJhY2tzOiBEaXNwb3NlQ2FsbGJhY2tbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgbG9jaygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pc0xvY2tlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgZGlzcG9zZShjYWxsYmFjazogRGlzcG9zZUNhbGxiYWNrKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBpbnZhbGlkYXRlKCk6IHZvaWQge1xuICAgICAgICByZWxvYWQoKTtcbiAgICB9XG5cbiAgICBkZWNsaW5lKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmlzRGVjbGluZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGFjY2VwdChfZGVwczogc3RyaW5nW10sIGNhbGxiYWNrOiB0cnVlIHwgQWNjZXB0Q2FsbGJhY2sgPSB0cnVlKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzTG9ja2VkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmlzQWNjZXB0ZWQpIHtcbiAgICAgICAgICAgIHNlbmRTb2NrZXRNZXNzYWdlKHsgaWQ6IHRoaXMuaWQsIHR5cGU6IFwiaG90QWNjZXB0XCIgfSk7XG4gICAgICAgICAgICB0aGlzLmlzQWNjZXB0ZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShfZGVwcykpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrID0gX2RlcHMgfHwgY2FsbGJhY2s7XG4gICAgICAgICAgICBfZGVwcyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjYWxsYmFjayA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgY2FsbGJhY2sgPSAoKSA9PiB7fTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkZXBzID0gX2RlcHMubWFwKChkZXApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4dCA9IGRlcC5zcGxpdChcIi5cIikucG9wKCk7XG4gICAgICAgICAgICBpZiAoIWV4dCkge1xuICAgICAgICAgICAgICAgIGRlcCArPSBcIi5qc1wiO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChleHQgIT09IFwianNcIikge1xuICAgICAgICAgICAgICAgIGRlcCArPSBcIi5wcm94eS5qc1wiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkwoZGVwLCBgJHt3aW5kb3cubG9jYXRpb24ub3JpZ2lufSR7dGhpcy5pZH1gKS5wYXRobmFtZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYWNjZXB0Q2FsbGJhY2tzLnB1c2goe1xuICAgICAgICAgICAgZGVwcyxcbiAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVIb3RDb250ZXh0KGZ1bGxVcmw6IHN0cmluZykge1xuICAgIGNvbnN0IGlkID0gbmV3IFVSTChmdWxsVXJsKS5wYXRobmFtZTtcbiAgICBjb25zdCBleGlzdGluZyA9IFJFR0lTVEVSRURfTU9EVUxFU1tpZF07XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgIGV4aXN0aW5nLmxvY2soKTtcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ZSA9IG5ldyBIb3RNb2R1bGVTdGF0ZShpZCk7XG4gICAgUkVHSVNURVJFRF9NT0RVTEVTW2lkXSA9IHN0YXRlO1xuICAgIHJldHVybiBzdGF0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYXBwbHlVcGRhdGUoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHN0YXRlID0gUkVHSVNURVJFRF9NT0RVTEVTW2lkXTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHN0YXRlLmlzRGVjbGluZWQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGFjY2VwdENhbGxiYWNrcyA9IHN0YXRlLmFjY2VwdENhbGxiYWNrcztcbiAgICBjb25zdCBkaXNwb3NlQ2FsbGJhY2tzID0gc3RhdGUuZGlzcG9zZUNhbGxiYWNrcztcbiAgICBzdGF0ZS5kaXNwb3NlQ2FsbGJhY2tzID0gW107XG4gICAgc3RhdGUuZGF0YSA9IHt9O1xuXG4gICAgZGlzcG9zZUNhbGxiYWNrcy5tYXAoKGNhbGxiYWNrKSA9PiBjYWxsYmFjaygpKTtcbiAgICBjb25zdCB1cGRhdGVJRCA9IERhdGUubm93KCk7XG4gICAgZm9yIChjb25zdCB7IGRlcHMsIGNhbGxiYWNrOiBhY2NlcHRDYWxsYmFjayB9IG9mIGFjY2VwdENhbGxiYWNrcykge1xuICAgICAgICBjb25zdCBbbW9kdWxlLCAuLi5kZXBNb2R1bGVzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIGltcG9ydChpZCArIGA/bXRpbWU9JHt1cGRhdGVJRH1gKSxcbiAgICAgICAgICAgIC4uLmRlcHMubWFwKChkKSA9PiBpbXBvcnQoZCArIGA/bXRpbWU9JHt1cGRhdGVJRH1gKSksXG4gICAgICAgIF0pO1xuICAgICAgICBhY2NlcHRDYWxsYmFjayh7IG1vZHVsZSwgZGVwczogZGVwTW9kdWxlcyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsICh7IGRhdGE6IF9kYXRhIH0pID0+IHtcbiAgICBpZiAoIV9kYXRhKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoX2RhdGEpO1xuICAgIGRlYnVnKFwibWVzc2FnZVwiLCBkYXRhKTtcbiAgICBpZiAoZGF0YS50eXBlID09PSBcInJlbG9hZFwiKSB7XG4gICAgICAgIGRlYnVnKFwibWVzc2FnZTogcmVsb2FkXCIpO1xuICAgICAgICByZWxvYWQoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZGF0YS50eXBlICE9PSBcInVwZGF0ZVwiKSB7XG4gICAgICAgIGRlYnVnKFwibWVzc2FnZTogdW5rbm93blwiLCBkYXRhKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWJ1ZyhcIm1lc3NhZ2U6IHVwZGF0ZVwiLCBkYXRhKTtcbiAgICBkZWJ1ZyhkYXRhLnVybCwgT2JqZWN0LmtleXMoUkVHSVNURVJFRF9NT0RVTEVTKSk7XG4gICAgYXBwbHlVcGRhdGUoZGF0YS51cmwpXG4gICAgICAgIC50aGVuKChvaykgPT4ge1xuICAgICAgICAgICAgaWYgKCFvaykge1xuICAgICAgICAgICAgICAgIHJlbG9hZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgcmVsb2FkKCk7XG4gICAgICAgIH0pO1xufSk7XG4iXX0=